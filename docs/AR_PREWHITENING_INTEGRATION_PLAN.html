<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>AR Prewhitening Integration Plan for hrfdecoder • hrfdecode</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><link href="extra.css" rel="stylesheet"><script src="extra.js"></script><meta property="og:title" content="AR Prewhitening Integration Plan for hrfdecoder"><script>document.addEventListener('DOMContentLoaded', function(){ document.body.classList.add('palette-red'); });</script><style>
  body.palette-red { --albers-accent: #d61f1f; --albers-link: #d61f1f; }
  .navbar-nav .nav-link { line-height: 1.25; padding-top: 0.5rem; padding-bottom: 0.5rem; }
</style></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">hrfdecode</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="articles/01-getting-started.html">Getting started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>How-tos</h6></li>
    <li><a class="dropdown-item" href="articles/02-ar-prewhitening.html">AR prewhitening</a></li>
    <li><a class="dropdown-item" href="articles/03-rmvpa-integration.html">rMVPA integration</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Explanations</h6></li>
    <li><a class="dropdown-item" href="articles/04-hrf-estimation.html">HRF estimation</a></li>
    <li><a class="dropdown-item" href="articles/05-weakly-supervised.html">Weakly supervised learning</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>AR Prewhitening Integration Plan for hrfdecoder</h1>

    </div>

<div id="ar-prewhitening-integration-plan-for-hrfdecoder" class="section level1">

<p><strong>Date:</strong> 2025-11-09 <strong>Authors:</strong> Analysis by 3 specialized sub-agents (fmriAR, rMVPA, hrfdecoder) <strong>Status:</strong> Design Complete, Ready for Implementation</p>
<hr><div class="section level2">
<h2 id="executive-summary">Executive Summary<a class="anchor" aria-label="anchor" href="#executive-summary"></a></h2>
<p>This document provides a comprehensive plan for integrating AR(1)/ARMA prewhitening into the hrfdecoder package using fmriAR, with full consideration of the rMVPA plugin architecture. The integration addresses autocorrelated noise in fMRI data while maintaining clean separation of concerns across the preprocessing pipeline.</p>
<div class="section level3">
<h3 id="key-findings">Key Findings<a class="anchor" aria-label="anchor" href="#key-findings"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Current State:</strong> hrfdecoder handles nuisance signals via pre-projection but does NOT address autocorrelated noise</li>
<li>
<strong>Optimal Solution:</strong> Use fmriAR for run-specific AR estimation and whitening</li>
<li>
<strong>Integration Point:</strong> Insert between baseline residualization and standardization</li>
<li>
<strong>rMVPA Impact:</strong> Minimal changes required; AR parameters passed through model spec</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="table-of-contents">Table of Contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a></h2>
<ol style="list-style-type: decimal"><li><a href="#id_1-current-noise-handling-analysis">Current Noise Handling Analysis</a></li>
<li><a href="#id_2-fmriar-capabilities-overview">fmriAR Capabilities Overview</a></li>
<li><a href="#id_3-rmvpa-architecture--constraints">rMVPA Architecture &amp; Constraints</a></li>
<li><a href="#id_4-integration-architecture">Integration Architecture</a></li>
<li><a href="#id_5-implementation-plan">Implementation Plan</a></li>
<li><a href="#id_6-testing-strategy">Testing Strategy</a></li>
<li><a href="#id_7-performance-considerations">Performance Considerations</a></li>
</ol><hr></div>
<div class="section level2">
<h2 id="id_1-current-noise-handling-analysis">1. Current Noise Handling Analysis<a class="anchor" aria-label="anchor" href="#id_1-current-noise-handling-analysis"></a></h2>
<div class="section level3">
<h3 id="id_11-autocorrelated-noise-not-handled">1.1 Autocorrelated Noise: NOT Handled<a class="anchor" aria-label="anchor" href="#id_11-autocorrelated-noise-not-handled"></a></h3>
<p><strong>Evidence from hrfdecoder:</strong></p>
<ul><li>
<p><strong>File:</strong> <a href="../src/softlabels_als.cpp#L39">src/softlabels_als.cpp:39</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>recon <span class="op">=</span> arma<span class="op">::</span>accu<span class="op">(</span>arma<span class="op">::</span>square<span class="op">(</span>S <span class="op">-</span> P<span class="op">));</span>  <span class="co">// Assumes i.i.d. noise</span></span></code></pre></div>
</li>
<li>
<p><strong>Objective function:</strong></p>
<pre><code>L = ||XW - P||²_F              (reconstruction - assumes white noise)
  + λ_W ||W||²_F                (weight regularization)
  + λ_HRF ||P - DBβ||²_F        (prior adherence)
  + λ_smooth P^T L P            (temporal smoothness)</code></pre>
</li>
</ul><p><strong>Why this matters:</strong></p>
<p>fMRI noise exhibits temporal autocorrelation (typically AR(1) with ρ ≈ 0.3-0.5):</p>
<ul><li>
<strong>Inflated degrees of freedom</strong> → Liberal statistical tests</li>
<li>
<strong>Suboptimal decoder weights</strong> → Not using GLS-optimal weights</li>
<li>
<strong>Biased variance estimates</strong> → Confidence intervals too narrow</li>
<li>
<strong>Reduced efficiency</strong> → More data needed for same power</li>
</ul><p><strong>Mentioned in design notes (Section 4):</strong> &gt; “AR(1) prewhitening per run prior to fitting” listed as <strong>optional enhancement</strong> (not implemented)</p>
<hr></div>
<div class="section level3">
<h3 id="id_12-nuisance-signals-handled-via-pre-projection-">1.2 Nuisance Signals: Handled via Pre-Projection ✓<a class="anchor" aria-label="anchor" href="#id_12-nuisance-signals-handled-via-pre-projection-"></a></h3>
<p><strong>Evidence from hrfdecoder:</strong></p>
<ul><li>
<p><strong>File:</strong> <a href="../R/fit.R#L40">R/fit.R:40</a></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/residualize_baseline.html">residualize_baseline</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">base_model</span><span class="op">)</span>  <span class="co"># BEFORE any fitting</span></span></code></pre></div>
</li>
<li>
<p><strong>Implementation:</strong> <a href="../R/interop_fmri.R#L44-L46">R/interop_fmri.R:44-46</a></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">residualize_baseline</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Y</span>, <span class="va">base_model</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">base_model</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span></span>
<span>  <span class="fu">fmridesign</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/residualize.html" class="external-link">residualize</a></span><span class="op">(</span><span class="va">base_model</span>, <span class="va">Y</span><span class="op">)</span>  <span class="co"># Delegate to fmridesign</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
</ul><p><strong>What gets removed:</strong></p>
<ul><li>Low-frequency drift (polynomial trends, high-pass filtering)</li>
<li>Motion artifacts (6 or 24 motion regressors)</li>
<li>Physiological noise (cardiac, respiratory if modeled)</li>
<li>Other nuisance regressors specified in <code>baseline_model</code>
</li>
</ul><p><strong>Approach: Orthogonal Projection</strong></p>
<pre><code>Y_clean = Y - X_baseline (X_baseline^T X_baseline)^(-1) X_baseline^T Y</code></pre>
<p><strong>Conclusion:</strong> ✓ Nuisance removal is properly implemented via pre-projection. No changes needed.</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_2-fmriar-capabilities-overview">2. fmriAR Capabilities Overview<a class="anchor" aria-label="anchor" href="#id_2-fmriar-capabilities-overview"></a></h2>
<div class="section level3">
<h3 id="id_21-core-functionality">2.1 Core Functionality<a class="anchor" aria-label="anchor" href="#id_21-core-functionality"></a></h3>
<p><strong>Package:</strong> fmriAR v0.3.0 <strong>Location:</strong> <code>/Users/bbuchsbaum/code/fmriAR</code></p>
<p><strong>Provides:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong>AR/ARMA parameter estimation</strong> from residuals (Yule-Walker, Hannan-Rissanen)</li>
<li>
<strong>Run-aware whitening</strong> with automatic boundary resets</li>
<li>
<strong>Censor-aware whitening</strong> for excluding bad TRs</li>
<li>
<strong>Multi-scale spatial pooling</strong> across parcel hierarchies</li>
<li><strong>AFNI-compatible restricted AR models</strong></li>
<li>
<strong>Fast C++ implementation</strong> with OpenMP parallelization</li>
</ol></div>
<div class="section level3">
<h3 id="id_22-api-design">2.2 API Design<a class="anchor" aria-label="anchor" href="#id_22-api-design"></a></h3>
<p><strong>Primary workflow:</strong></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Estimate AR/ARMA noise model from residuals</span></span>
<span><span class="va">plan</span> <span class="op">&lt;-</span> <span class="fu">fit_noise</span><span class="op">(</span></span>
<span>  <span class="va">resid</span>,                  <span class="co"># (T x V) residual matrix</span></span>
<span>  runs <span class="op">=</span> <span class="va">run_ids</span>,         <span class="co"># Run identifiers (respects boundaries)</span></span>
<span>  method <span class="op">=</span> <span class="st">"ar"</span>,          <span class="co"># or "arma"</span></span>
<span>  p <span class="op">=</span> <span class="st">"auto"</span>,             <span class="co"># Auto-select order via BIC (or specify integer)</span></span>
<span>  q <span class="op">=</span> <span class="fl">0</span>,                  <span class="co"># MA order (0 for pure AR)</span></span>
<span>  exact_first <span class="op">=</span> <span class="st">"ar1"</span>     <span class="co"># Exact AR(1) scaling at segment starts</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Apply whitening to design and data matrices</span></span>
<span><span class="va">whitened</span> <span class="op">&lt;-</span> <span class="fu">whiten_apply</span><span class="op">(</span></span>
<span>  <span class="va">plan</span>,</span>
<span>  <span class="va">X</span>, <span class="va">Y</span>,</span>
<span>  runs <span class="op">=</span> <span class="va">run_ids</span>,         <span class="co"># Same run structure as estimation</span></span>
<span>  censor <span class="op">=</span> <span class="cn">NULL</span>           <span class="co"># Optional: indices of bad TRs to skip</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Use whitened data</span></span>
<span><span class="va">X_white</span> <span class="op">&lt;-</span> <span class="va">whitened</span><span class="op">$</span><span class="va">X</span></span>
<span><span class="va">Y_white</span> <span class="op">&lt;-</span> <span class="va">whitened</span><span class="op">$</span><span class="va">Y</span></span></code></pre></div>
<p><strong>Returned objects:</strong></p>
<ul><li>
<strong><code>fit_noise()</code></strong> → <code>fmriAR_plan</code> S3 object with:
<ul><li>
<code>phi</code>: AR coefficients (per-run or pooled)</li>
<li>
<code>theta</code>: MA coefficients</li>
<li>
<code>order</code>: (p, q)</li>
<li>
<code>runs</code>: Run labels</li>
<li>
<code>method</code>: “ar”, “arma”, or “afni”</li>
</ul></li>
<li>
<strong><code>whiten_apply()</code></strong> → List with:
<ul><li>
<code>X</code>: Whitened design matrix</li>
<li>
<code>Y</code>: Whitened data matrix</li>
</ul></li>
</ul></div>
<div class="section level3">
<h3 id="id_23-run-specific-ar-handling">2.3 Run-Specific AR Handling<a class="anchor" aria-label="anchor" href="#id_23-run-specific-ar-handling"></a></h3>
<p><strong>Key feature:</strong> Estimates separate AR parameters per run and resets whitening buffers at run boundaries.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">runs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, each<span class="op">=</span><span class="fl">100</span><span class="op">)</span>  <span class="co"># 3 runs of 100 TRs each</span></span>
<span></span>
<span><span class="va">plan</span> <span class="op">&lt;-</span> <span class="fu">fit_noise</span><span class="op">(</span><span class="va">resid</span>, runs <span class="op">=</span> <span class="va">runs</span>, pooling <span class="op">=</span> <span class="st">"run"</span>, p <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># plan$phi = list(φ₁, φ₂, φ₃)  # One per run</span></span>
<span></span>
<span><span class="va">whitened</span> <span class="op">&lt;-</span> <span class="fu">whiten_apply</span><span class="op">(</span><span class="va">plan</span>, <span class="va">X</span>, <span class="va">Y</span>, runs <span class="op">=</span> <span class="va">runs</span><span class="op">)</span></span>
<span><span class="co"># Applies run-specific φᵣ and resets AR state at run boundaries</span></span></code></pre></div>
<p><strong>C++ implementation:</strong> <code>arma_whiten_inplace()</code> in <a href="https://github.com/bbuchsbaum/fmriAR/blob/main/src/fmriAR_whiten.cpp" class="external-link">fmriAR/src/fmriAR_whiten.cpp</a></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co">// Pseudocode: For each time t and voxel j:</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="dt">y_t</span><span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> <span class="dt">y_t</span><span class="op">[</span>j<span class="op">]</span> <span class="op">-</span> <span class="va">sum_</span><span class="op">{</span>k<span class="op">=</span><span class="dv">1</span><span class="op">}^</span>p φ_k <span class="op">*</span> <span class="va">y_</span><span class="op">{</span>t<span class="op">-</span>k<span class="op">}[</span>j<span class="op">]</span>  <span class="co">// AR filter</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">// At run boundaries:</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co">// - Reset buffers (no cross-run AR dependency)</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co">// - Apply exact_first_ar1 scaling if p=1: y_t[j] *= sqrt(1 - φ₁²)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_24-traintest-workflow">2.4 Train/Test Workflow<a class="anchor" aria-label="anchor" href="#id_24-traintest-workflow"></a></h3>
<p><strong>Critical design pattern for cross-validation:</strong></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># TRAINING PHASE</span></span>
<span><span class="co"># Step 1: Fit AR model on training residuals</span></span>
<span><span class="va">train_resid</span> <span class="op">&lt;-</span> <span class="va">Y_train</span> <span class="op">-</span> <span class="va">X_train</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">X_train</span>, <span class="va">Y_train</span><span class="op">)</span></span>
<span><span class="va">plan</span> <span class="op">&lt;-</span> <span class="fu">fit_noise</span><span class="op">(</span><span class="va">train_resid</span>, runs <span class="op">=</span> <span class="va">train_runs</span>, method <span class="op">=</span> <span class="st">"ar"</span>, p <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Whiten training data</span></span>
<span><span class="va">train_white</span> <span class="op">&lt;-</span> <span class="fu">whiten_apply</span><span class="op">(</span><span class="va">plan</span>, <span class="va">X_train</span>, <span class="va">Y_train</span>, runs <span class="op">=</span> <span class="va">train_runs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># TESTING PHASE</span></span>
<span><span class="co"># Step 3: Apply SAME plan to test data (no re-estimation!)</span></span>
<span><span class="va">test_white</span> <span class="op">&lt;-</span> <span class="fu">whiten_apply</span><span class="op">(</span><span class="va">plan</span>, <span class="va">X_test</span>, <span class="va">Y_test</span>, runs <span class="op">=</span> <span class="va">test_runs</span><span class="op">)</span></span></code></pre></div>
<p><strong>Key principle:</strong> AR parameters learned from training data only, then frozen for test application.</p>
</div>
<div class="section level3">
<h3 id="id_25-integration-strengths">2.5 Integration Strengths<a class="anchor" aria-label="anchor" href="#id_25-integration-strengths"></a></h3>
<p>✓ <strong>Run-aware:</strong> Proper multi-run fMRI handling ✓ <strong>Train/test separation:</strong> Plan estimated once, applied to both ✓ <strong>Fast:</strong> C++ + OpenMP parallelization ✓ <strong>Flexible pooling:</strong> Global, run-specific, or parcel-based AR ✓ <strong>Censoring support:</strong> Can exclude bad TRs ✓ <strong>Production-ready:</strong> Mature package with comprehensive tests</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_3-rmvpa-architecture--constraints">3. rMVPA Architecture &amp; Constraints<a class="anchor" aria-label="anchor" href="#id_3-rmvpa-architecture--constraints"></a></h2>
<div class="section level3">
<h3 id="id_31-model-plugin-system">3.1 Model Plugin System<a class="anchor" aria-label="anchor" href="#id_31-model-plugin-system"></a></h3>
<p><strong>Package:</strong> rMVPA <strong>Location:</strong> <code>/Users/bbuchsbaum/code/rMVPA</code></p>
<p><strong>S3 Method Dispatch Pattern:</strong></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Core generics for any model plugin:</span></span>
<span><span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/train_model.html" class="external-link">train_model</a></span><span class="op">(</span><span class="va">obj</span>, <span class="va">train_dat</span>, <span class="va">y</span>, <span class="va">sl_info</span>, <span class="va">cv_spec</span>, <span class="va">indices</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/predict_model.html" class="external-link">predict_model</a></span><span class="op">(</span><span class="va">obj</span>, <span class="va">new_data</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/format_result.html" class="external-link">format_result</a></span><span class="op">(</span><span class="va">obj</span>, <span class="va">result</span>, <span class="va">error_message</span>, <span class="va">context</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/merge_results.html" class="external-link">merge_results</a></span><span class="op">(</span><span class="va">obj</span>, <span class="va">result_set</span>, <span class="va">indices</span>, <span class="va">id</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/compute_performance-methods.html" class="external-link">compute_performance</a></span><span class="op">(</span><span class="va">obj</span>, <span class="va">result</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p><strong>hrfdecoder integration:</strong> <strong>File:</strong> <a href="../R/hrfdecoder_model.R">R/hrfdecoder_model.R</a></p>
<p>Already implements all required S3 methods: - <code>train_model.hrfdecoder_model()</code> (lines 48-71) - <code>format_result.hrfdecoder_model()</code> (lines 74-105) - <code>merge_results.hrfdecoder_model()</code> (lines 108-126)</p>
</div>
<div class="section level3">
<h3 id="id_32-data-flow-in-cross-validation">3.2 Data Flow in Cross-Validation<a class="anchor" aria-label="anchor" href="#id_32-data-flow-in-cross-validation"></a></h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│ 1. ROI/Searchlight Extraction                              │
│    mvpa_iterate() extracts T×V matrix per ROI              │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. Cross-Validation Fold Creation                          │
│    Based on block_var (run IDs) or custom CV scheme        │
│    → train_indices, test_indices                           │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. PER FOLD:                                                │
│    a. train_model() called with train_dat                  │
│       → Fits decoder on training subset                    │
│    b. format_result() called with test data                │
│       → Predicts on test subset                            │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. merge_results() across folds                            │
│    → Combined classification_result                        │
└─────────────────────────────────────────────────────────────┘</code></pre>
</div>
<div class="section level3">
<h3 id="id_33-preprocessing-integration-points">3.3 Preprocessing Integration Points<a class="anchor" aria-label="anchor" href="#id_33-preprocessing-integration-points"></a></h3>
<p><strong>Two architectural options identified:</strong></p>
<div class="section level4">
<h4 id="option-a-per-fold-preprocessing-recommended"><strong>Option A: Per-Fold Preprocessing (RECOMMENDED)</strong><a class="anchor" aria-label="anchor" href="#option-a-per-fold-preprocessing-recommended"></a></h4>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_model.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">train_dat</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">train_dat</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ===== AR PREWHITENING HAPPENS HERE =====</span></span>
<span>  <span class="co"># 1. Estimate AR from training residuals</span></span>
<span>  <span class="co"># 2. Whiten training data</span></span>
<span>  <span class="co"># 3. Store plan in fit object</span></span>
<span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder</a></span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">X_train_white</span>,  <span class="co"># Whitened data</span></span>
<span>    ev_model <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">event_model</span>,</span>
<span>    ar_plan <span class="op">=</span> <span class="va">plan</span>,     <span class="co"># NEW: Store for test application</span></span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">format_result.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">result</span>, <span class="va">context</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">context</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ===== APPLY SAME AR PLAN TO TEST DATA =====</span></span>
<span>  <span class="va">X_test_white</span> <span class="op">&lt;-</span> <span class="fu">whiten_apply</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">fit</span><span class="op">$</span><span class="va">ar_plan</span>, <span class="cn">NULL</span>, <span class="va">X_test</span><span class="op">)</span><span class="op">$</span><span class="va">Y</span></span>
<span></span>
<span>  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/predict_hrfdecoder.html">predict_hrfdecoder</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">fit</span>, <span class="va">X_test_white</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">preds</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Pros:</strong> - ✓ CV-safe: AR estimated from training fold only - ✓ Minimal rMVPA changes: Contained in model-specific methods - ✓ Flexible: Each fold can have different AR structure</p>
<p><strong>Cons:</strong> - ✗ Redundant computation: Re-estimates AR for each fold - ✗ More complex: Logic split across train/predict</p>
</div>
<div class="section level4">
<h4 id="option-b-dataset-level-preprocessing"><strong>Option B: Dataset-Level Preprocessing</strong><a class="anchor" aria-label="anchor" href="#option-b-dataset-level-preprocessing"></a></h4>
<p>Prewhiten entire dataset before passing to rMVPA. <strong>NOT RECOMMENDED</strong> because: - ✗ CV leakage: Test data influences AR estimation - ✗ Less flexible: Can’t adapt AR per fold</p>
</div>
</div>
<div class="section level3">
<h3 id="id_34-key-constraints-from-rmvpa">3.4 Key Constraints from rMVPA<a class="anchor" aria-label="anchor" href="#id_34-key-constraints-from-rmvpa"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Blocked CV is standard:</strong> Uses <code>block_var</code> (run IDs) to create folds</li>
<li>
<strong>Result format required:</strong> Must return tibble with columns <code>class</code>, <code>probs</code>, <code>y_true</code>, <code>test_ind</code>, <code>fit</code>, <code>error</code>, <code>error_message</code>
</li>
<li>
<strong>Event model required:</strong> For trial-level evaluation (the default mode)</li>
<li>
<strong>Standardization handling:</strong> rMVPA may pre-standardize; hrfdecoder currently calls with <code>standardize = FALSE</code> in rMVPA context</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="id_4-integration-architecture">4. Integration Architecture<a class="anchor" aria-label="anchor" href="#id_4-integration-architecture"></a></h2>
<div class="section level3">
<h3 id="id_41-preprocessing-pipeline-order">4.1 Preprocessing Pipeline Order<a class="anchor" aria-label="anchor" href="#id_41-preprocessing-pipeline-order"></a></h3>
<p><strong>RECOMMENDED ORDER:</strong></p>
<pre><code>Input Y (T × V raw fMRI data)
          ↓
┌─────────────────────────────────────────┐
│ 1. Baseline Residualization             │  [R/fit.R:40]
│    Y ← residualize_baseline(Y, base_model)
│    Removes: drift, motion, nuisance    │
└─────────────────┬───────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ 2. AR Prewhitening (NEW)                │  [INSERTION POINT]
│    plan ← fit_noise(Y, runs, p)        │
│    Y ← whiten_apply(plan, NULL, Y)$Y   │
│    Removes: temporal autocorrelation   │
└─────────────────┬───────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ 3. Standardization                      │  [R/fit.R:43-50]
│    Y ← scale(Y)                        │
│    Z-scores: (Y - mean) / sd           │
└─────────────────┬───────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ 4. Decoder Input Preparation            │  [R/prep.R:40-58]
│    X_list, DBbeta, P0 ← prepare_decoder_inputs()
│    L ← build_laplacian_from_runs()    │
└─────────────────┬───────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ 5. ALS Solver                           │  [src/softlabels_als.cpp:68]
│    W, P, b ← fit_softlabels_als()      │
└─────────────────────────────────────────┘</code></pre>
<p><strong>Rationale:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong>Baseline FIRST:</strong> Removes structured nuisance before AR estimation</li>
<li>
<strong>AR SECOND:</strong> Estimates autocorrelation on residuals (after nuisance removal)</li>
<li>
<strong>Standardization THIRD:</strong> Z-scores applied to whitened residuals</li>
<li>
<strong>ALS LAST:</strong> Operates on fully preprocessed data</li>
</ol></div>
<div class="section level3">
<h3 id="id_42-exact-code-insertion-point">4.2 Exact Code Insertion Point<a class="anchor" aria-label="anchor" href="#id_42-exact-code-insertion-point"></a></h3>
<p><strong>File:</strong> <code>/Users/bbuchsbaum/code/hrfdecoder/R/fit.R</code> <strong>Location:</strong> Between lines 40 and 42</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_hrfdecoder</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">Y</span>,</span>
<span>  <span class="va">ev_model</span>,</span>
<span>  <span class="va">base_model</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">hrf</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">ar_order</span> <span class="op">=</span> <span class="fl">1</span>,              <span class="co"># NEW PARAMETER</span></span>
<span>  <span class="va">ar_method</span> <span class="op">=</span> <span class="st">"ar"</span>,          <span class="co"># NEW: "ar" or "arma"</span></span>
<span>  <span class="va">ar_pooling</span> <span class="op">=</span> <span class="st">"run"</span>,        <span class="co"># NEW: "global" or "run"</span></span>
<span>  <span class="va">lambda_W</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  <span class="va">lambda_HRF</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="va">lambda_smooth</span> <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  <span class="va">theta_penalty</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  <span class="va">max_iter</span> <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  <span class="va">tol</span> <span class="op">=</span> <span class="fl">1e-4</span>,</span>
<span>  <span class="va">nonneg</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">background</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">standardize</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">verbose</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">is.matrix</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">ev_model</span>, <span class="st">"event_model"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">Tn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ===== STEP 1: Baseline residualization =====</span></span>
<span>  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/residualize_baseline.html">residualize_baseline</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">base_model</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ===== STEP 2: AR PREWHITENING (NEW) =====</span></span>
<span>  <span class="va">ar_plan</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">ar_order</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">ar_order</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Need run_ids BEFORE prep</span></span>
<span>    <span class="va">prep_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/prepare_decoder_inputs.html">prepare_decoder_inputs</a></span><span class="op">(</span><span class="va">ev_model</span>, hrf <span class="op">=</span> <span class="va">hrf</span>, background <span class="op">=</span> <span class="va">background</span><span class="op">)</span></span>
<span>    <span class="va">run_ids</span> <span class="op">&lt;-</span> <span class="va">prep_temp</span><span class="op">$</span><span class="va">run_ids</span></span>
<span></span>
<span>    <span class="co"># Estimate AR from current Y (post-baseline, pre-standardization)</span></span>
<span>    <span class="va">ar_plan</span> <span class="op">&lt;-</span> <span class="fu">fmriAR</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmriAR/reference/fit_noise.html" class="external-link">fit_noise</a></span><span class="op">(</span></span>
<span>      <span class="va">Y</span>,</span>
<span>      runs <span class="op">=</span> <span class="va">run_ids</span>,</span>
<span>      method <span class="op">=</span> <span class="va">ar_method</span>,</span>
<span>      p <span class="op">=</span> <span class="va">ar_order</span>,</span>
<span>      pooling <span class="op">=</span> <span class="va">ar_pooling</span>,</span>
<span>      exact_first <span class="op">=</span> <span class="st">"ar1"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Apply whitening</span></span>
<span>    <span class="va">Y_white</span> <span class="op">&lt;-</span> <span class="fu">fmriAR</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmriAR/reference/whiten_apply.html" class="external-link">whiten_apply</a></span><span class="op">(</span><span class="va">ar_plan</span>, X <span class="op">=</span> <span class="cn">NULL</span>, Y <span class="op">=</span> <span class="va">Y</span>, runs <span class="op">=</span> <span class="va">run_ids</span><span class="op">)</span></span>
<span>    <span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">Y_white</span><span class="op">$</span><span class="va">Y</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">verbose</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Applied AR("</span>, <span class="va">ar_order</span>, <span class="st">") prewhitening (pooling="</span>, <span class="va">ar_pooling</span>, <span class="st">")"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># ===== STEP 3: Standardization =====</span></span>
<span>  <span class="va">preproc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    standardize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">standardize</span><span class="op">)</span>,</span>
<span>    center <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    scale <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    ar_plan <span class="op">=</span> <span class="va">ar_plan</span>  <span class="co"># NEW: Store for predict</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">standardize</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Ys</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span></span>
<span>    <span class="va">preproc</span><span class="op">$</span><span class="va">center</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">Ys</span>, <span class="st">"scaled:center"</span><span class="op">)</span></span>
<span>    <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">Ys</span>, <span class="st">"scaled:scale"</span><span class="op">)</span></span>
<span>    <span class="va">s</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">|</span> <span class="va">s</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="va">preproc</span><span class="op">$</span><span class="va">scale</span> <span class="op">&lt;-</span> <span class="va">s</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">Ys</span>, <span class="st">"scaled:center"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">Ys</span>, <span class="st">"scaled:scale"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">Ys</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># ===== STEP 4: Decoder preparation &amp; fitting =====</span></span>
<span>  <span class="va">prep</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/prepare_decoder_inputs.html">prepare_decoder_inputs</a></span><span class="op">(</span><span class="va">ev_model</span>, hrf <span class="op">=</span> <span class="va">hrf</span>, background <span class="op">=</span> <span class="va">background</span><span class="op">)</span></span>
<span>  <span class="co"># ... (rest unchanged)</span></span>
<span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    W <span class="op">=</span> <span class="va">fit_cpp</span><span class="op">$</span><span class="va">W</span>,</span>
<span>    P <span class="op">=</span> <span class="va">Z</span>,</span>
<span>    b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fit_cpp</span><span class="op">$</span><span class="va">b</span><span class="op">)</span>,</span>
<span>    theta <span class="op">=</span> <span class="va">theta</span>,</span>
<span>    hrf <span class="op">=</span> <span class="va">hrf_est</span>,</span>
<span>    conditions <span class="op">=</span> <span class="va">prep</span><span class="op">$</span><span class="va">conditions</span>,</span>
<span>    background <span class="op">=</span> <span class="va">background</span>,</span>
<span>    converged <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">fit_cpp</span><span class="op">$</span><span class="va">converged</span><span class="op">)</span>,</span>
<span>    iterations <span class="op">=</span> <span class="va">fit_cpp</span><span class="op">$</span><span class="va">iterations</span>,</span>
<span>    settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      lambda_W <span class="op">=</span> <span class="va">lambda_W</span>,</span>
<span>      lambda_HRF <span class="op">=</span> <span class="va">lambda_HRF</span>,</span>
<span>      lambda_smooth <span class="op">=</span> <span class="va">lambda_smooth</span>,</span>
<span>      theta_penalty <span class="op">=</span> <span class="va">theta_penalty</span>,</span>
<span>      max_iter <span class="op">=</span> <span class="va">max_iter</span>,</span>
<span>      tol <span class="op">=</span> <span class="va">tol</span>,</span>
<span>      nonneg <span class="op">=</span> <span class="va">nonneg</span>,</span>
<span>      background <span class="op">=</span> <span class="va">background</span>,</span>
<span>      TR <span class="op">=</span> <span class="va">TR</span>,</span>
<span>      run_ids <span class="op">=</span> <span class="va">prep</span><span class="op">$</span><span class="va">run_ids</span>,</span>
<span>      ar_order <span class="op">=</span> <span class="va">ar_order</span>,         <span class="co"># NEW</span></span>
<span>      ar_method <span class="op">=</span> <span class="va">ar_method</span>,        <span class="co"># NEW</span></span>
<span>      ar_pooling <span class="op">=</span> <span class="va">ar_pooling</span>       <span class="co"># NEW</span></span>
<span>    <span class="op">)</span>,</span>
<span>    train <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      P0 <span class="op">=</span> <span class="va">prep</span><span class="op">$</span><span class="va">P0</span>,</span>
<span>      prior <span class="op">=</span> <span class="va">prep</span><span class="op">$</span><span class="va">DBbeta</span>,</span>
<span>      events <span class="op">=</span> <span class="va">events_tbl</span></span>
<span>    <span class="op">)</span>,</span>
<span>    preproc <span class="op">=</span> <span class="va">preproc</span>,              <span class="co"># Contains ar_plan</span></span>
<span>    diagnostics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      obj_trace <span class="op">=</span> <span class="va">fit_cpp</span><span class="op">$</span><span class="va">obj_trace</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"hrfdecoder_fit"</span></span>
<span>  <span class="va">fit</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_43-prediction-update">4.3 Prediction Update<a class="anchor" aria-label="anchor" href="#id_43-prediction-update"></a></h3>
<p><strong>File:</strong> <code>/Users/bbuchsbaum/code/hrfdecoder/R/predict.R</code> <strong>Location:</strong> Lines 21-27 (preprocessing section)</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict_hrfdecoder</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  <span class="va">Y_test</span>,</span>
<span>  <span class="va">ev_model_test</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">mode</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tr"</span>, <span class="st">"trial"</span><span class="op">)</span>,</span>
<span>  <span class="va">window</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>  <span class="va">weights</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hrf"</span>, <span class="st">"flat"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">object</span>, <span class="st">"hrfdecoder_fit"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mode</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">mode</span><span class="op">)</span></span>
<span>  <span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">weights</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ===== APPLY PREPROCESSING IN SAME ORDER AS TRAINING =====</span></span>
<span></span>
<span>  <span class="co"># STEP 1: AR prewhitening (if was applied during training)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">preproc</span><span class="op">$</span><span class="va">ar_plan</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">run_ids_test</span> <span class="op">&lt;-</span> <span class="fu">get_run_ids_from_test_data</span><span class="op">(</span><span class="va">object</span>, <span class="va">Y_test</span>, <span class="va">ev_model_test</span><span class="op">)</span></span>
<span>    <span class="va">Y_white</span> <span class="op">&lt;-</span> <span class="fu">fmriAR</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmriAR/reference/whiten_apply.html" class="external-link">whiten_apply</a></span><span class="op">(</span></span>
<span>      <span class="va">object</span><span class="op">$</span><span class="va">preproc</span><span class="op">$</span><span class="va">ar_plan</span>,</span>
<span>      X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>      Y <span class="op">=</span> <span class="va">Y_test</span>,</span>
<span>      runs <span class="op">=</span> <span class="va">run_ids_test</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">Y_test</span> <span class="op">&lt;-</span> <span class="va">Y_white</span><span class="op">$</span><span class="va">Y</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># STEP 2: Standardization (if was applied during training)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">preproc</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">preproc</span><span class="op">$</span><span class="va">standardize</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ctr</span> <span class="op">&lt;-</span> <span class="va">object</span><span class="op">$</span><span class="va">preproc</span><span class="op">$</span><span class="va">center</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Y_test</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">scl</span> <span class="op">&lt;-</span> <span class="va">object</span><span class="op">$</span><span class="va">preproc</span><span class="op">$</span><span class="va">scale</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Y_test</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">scl</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">scl</span><span class="op">)</span> <span class="op">|</span> <span class="va">scl</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="va">Y_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="va">Y_test</span>, <span class="fl">2</span>, <span class="va">ctr</span>, FUN <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span>
<span>    <span class="va">Y_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="va">Y_test</span>, <span class="fl">2</span>, <span class="va">scl</span>, FUN <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># ===== COMPUTE PREDICTIONS =====</span></span>
<span>  <span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu">predict_softlabels</span><span class="op">(</span><span class="va">Y_test</span>, <span class="va">object</span><span class="op">$</span><span class="va">W</span>, <span class="va">object</span><span class="op">$</span><span class="va">b</span><span class="op">)</span></span>
<span>  <span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu">row_softmax</span><span class="op">(</span><span class="va">scores</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ... (rest unchanged)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># NEW HELPER FUNCTION</span></span>
<span><span class="va">get_run_ids_from_test_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit_obj</span>, <span class="va">Y_test</span>, <span class="va">ev_model_test</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Extract run IDs for test data</span></span>
<span>  <span class="co"># Option 1: From ev_model_test if provided</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">ev_model_test</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">prep</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/prepare_decoder_inputs.html">prepare_decoder_inputs</a></span><span class="op">(</span><span class="va">ev_model_test</span>, hrf <span class="op">=</span> <span class="va">fit_obj</span><span class="op">$</span><span class="va">hrf</span>,</span>
<span>                                   background <span class="op">=</span> <span class="va">fit_obj</span><span class="op">$</span><span class="va">background</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">prep</span><span class="op">$</span><span class="va">run_ids</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Option 2: Assume same run structure as training (if single-run test)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Y_test</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">fit_obj</span><span class="op">$</span><span class="va">settings</span><span class="op">$</span><span class="va">run_ids</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">fit_obj</span><span class="op">$</span><span class="va">settings</span><span class="op">$</span><span class="va">run_ids</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Option 3: Default to single run</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Y_test</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_44-rmvpa-integration-updates">4.4 rMVPA Integration Updates<a class="anchor" aria-label="anchor" href="#id_44-rmvpa-integration-updates"></a></h3>
<p><strong>File:</strong> <code>/Users/bbuchsbaum/code/hrfdecoder/R/hrfdecoder_model.R</code> <strong>Updates required:</strong></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">dataset</span>,</span>
<span>  <span class="va">design</span>,</span>
<span>  <span class="va">lambda_W</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  <span class="va">lambda_HRF</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="va">lambda_smooth</span> <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  <span class="va">theta_penalty</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  <span class="va">basis</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">window</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>  <span class="va">nonneg</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">max_iter</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  <span class="va">tol</span> <span class="op">=</span> <span class="fl">1e-4</span>,</span>
<span>  <span class="va">ar_order</span> <span class="op">=</span> <span class="fl">1</span>,           <span class="co"># NEW</span></span>
<span>  <span class="va">ar_method</span> <span class="op">=</span> <span class="st">"ar"</span>,       <span class="co"># NEW</span></span>
<span>  <span class="va">ar_pooling</span> <span class="op">=</span> <span class="st">"run"</span>,     <span class="co"># NEW</span></span>
<span>  <span class="va">performance</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">crossval</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">return_predictions</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">return_fits</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ... auto-detect CV ...</span></span>
<span></span>
<span>  <span class="fu">rMVPA</span><span class="fu">::</span><span class="fu">create_model_spec</span><span class="op">(</span></span>
<span>    <span class="st">"hrfdecoder_model"</span>,</span>
<span>    dataset <span class="op">=</span> <span class="va">dataset</span>,</span>
<span>    design <span class="op">=</span> <span class="va">design</span>,</span>
<span>    lambda_W <span class="op">=</span> <span class="va">lambda_W</span>,</span>
<span>    lambda_HRF <span class="op">=</span> <span class="va">lambda_HRF</span>,</span>
<span>    lambda_smooth <span class="op">=</span> <span class="va">lambda_smooth</span>,</span>
<span>    theta_penalty <span class="op">=</span> <span class="va">theta_penalty</span>,</span>
<span>    basis <span class="op">=</span> <span class="va">basis</span>,</span>
<span>    window <span class="op">=</span> <span class="va">window</span>,</span>
<span>    nonneg <span class="op">=</span> <span class="va">nonneg</span>,</span>
<span>    max_iter <span class="op">=</span> <span class="va">max_iter</span>,</span>
<span>    tol <span class="op">=</span> <span class="va">tol</span>,</span>
<span>    ar_order <span class="op">=</span> <span class="va">ar_order</span>,        <span class="co"># NEW</span></span>
<span>    ar_method <span class="op">=</span> <span class="va">ar_method</span>,      <span class="co"># NEW</span></span>
<span>    ar_pooling <span class="op">=</span> <span class="va">ar_pooling</span>,    <span class="co"># NEW</span></span>
<span>    crossval <span class="op">=</span> <span class="va">crossval</span>,</span>
<span>    performance <span class="op">=</span> <span class="va">performance</span>,</span>
<span>    compute_performance <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    return_predictions <span class="op">=</span> <span class="va">return_predictions</span>,</span>
<span>    return_fits <span class="op">=</span> <span class="va">return_fits</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># train_model.hrfdecoder_model UNCHANGED - just passes ar_order to fit_hrfdecoder</span></span>
<span><span class="va">train_model.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">train_dat</span>, <span class="va">y</span>, <span class="va">sl_info</span>, <span class="va">cv_spec</span>, <span class="va">indices</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">train_dat</span><span class="op">)</span></span>
<span>  <span class="va">ev_model</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">event_model</span></span>
<span>  <span class="va">base_model</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">baseline_model</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NULL</span></span>
<span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder</a></span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">X</span>,</span>
<span>    ev_model <span class="op">=</span> <span class="va">ev_model</span>,</span>
<span>    base_model <span class="op">=</span> <span class="va">base_model</span>,</span>
<span>    hrf <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">basis</span>,</span>
<span>    lambda_W <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">lambda_W</span>,</span>
<span>    lambda_HRF <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">lambda_HRF</span>,</span>
<span>    lambda_smooth <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">lambda_smooth</span>,</span>
<span>    theta_penalty <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">theta_penalty</span>,</span>
<span>    ar_order <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">ar_order</span>,       <span class="co"># NEW</span></span>
<span>    ar_method <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">ar_method</span>,     <span class="co"># NEW</span></span>
<span>    ar_pooling <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">ar_pooling</span>,   <span class="co"># NEW</span></span>
<span>    max_iter <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">max_iter</span>,</span>
<span>    tol <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">tol</span>,</span>
<span>    nonneg <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">nonneg</span>,</span>
<span>    standardize <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    verbose <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fit <span class="op">=</span> <span class="va">fit</span>, sl_info <span class="op">=</span> <span class="va">sl_info</span>, indices <span class="op">=</span> <span class="va">indices</span><span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="st">"hrfdecoder_fit_wrap"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># format_result.hrfdecoder_model UNCHANGED - predict_hrfdecoder handles AR internally</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_5-implementation-plan">5. Implementation Plan<a class="anchor" aria-label="anchor" href="#id_5-implementation-plan"></a></h2>
<div class="section level3">
<h3 id="id_51-phase-1-core-ar-integration-week-1">5.1 Phase 1: Core AR Integration (Week 1)<a class="anchor" aria-label="anchor" href="#id_51-phase-1-core-ar-integration-week-1"></a></h3>
<p><strong>Files to modify:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong><code>R/fit.R</code></strong> (main changes)
<ul><li>Add parameters: <code>ar_order</code>, <code>ar_method</code>, <code>ar_pooling</code>
</li>
<li>Insert AR prewhitening between lines 40-42</li>
<li>Store <code>ar_plan</code> in <code>fit$preproc</code>
</li>
<li>Store AR settings in <code>fit$settings</code>
</li>
</ul></li>
<li>
<strong><code>R/predict.R</code></strong>
<ul><li>Apply AR whitening before standardization</li>
<li>Add helper <code>get_run_ids_from_test_data()</code>
</li>
</ul></li>
<li>
<strong><code>R/hrfdecoder_model.R</code></strong>
<ul><li>Add AR parameters to <code><a href="reference/hrfdecoder_model.html">hrfdecoder_model()</a></code> signature</li>
<li>Pass through to <code><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder()</a></code> in <code><a href="http://bbuchsbaum.github.io/rMVPA/reference/train_model.html" class="external-link">train_model()</a></code>
</li>
</ul></li>
<li>
<strong><code>DESCRIPTION</code></strong>
<ul><li>Add <code>fmriAR (&gt;= 0.3.0)</code> to Imports</li>
<li>Add remote: <code>bbuchsbaum/fmriAR</code>
</li>
</ul></li>
<li>
<strong><code>NAMESPACE</code></strong>
<ul><li>Import: <code><a href="https://bbuchsbaum.github.io/fmriAR/reference/fit_noise.html" class="external-link">fmriAR::fit_noise</a></code>, <code><a href="https://bbuchsbaum.github.io/fmriAR/reference/whiten_apply.html" class="external-link">fmriAR::whiten_apply</a></code>
</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="id_52-phase-2-testing--validation-week-1-2">5.2 Phase 2: Testing &amp; Validation (Week 1-2)<a class="anchor" aria-label="anchor" href="#id_52-phase-2-testing--validation-week-1-2"></a></h3>
<p><strong>New test file:</strong> <code>tests/testthat/test-ar-prewhitening.R</code></p>
<p><strong>Test cases:</strong></p>
<ol style="list-style-type: decimal"><li>
<p><strong>Decorrelation test:</strong></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"AR(1) prewhitening reduces autocorrelation in residuals"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Generate AR(1) data with known phi</span></span>
<span>  <span class="co"># Fit with ar_order=1</span></span>
<span>  <span class="co"># Check: residual ACF near zero at lag 1</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Multi-run test:</strong></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Run-specific AR parameters are estimated and applied"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Simulate 3 runs with different AR parameters</span></span>
<span>  <span class="co"># Fit with ar_pooling="run"</span></span>
<span>  <span class="co"># Check: fit$preproc$ar_plan has 3 different phi values</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Train/test consistency:</strong></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"AR plan from training is applied to test data"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Train on runs 1-2, test on run 3</span></span>
<span>  <span class="co"># Verify: test predictions use stored ar_plan</span></span>
<span>  <span class="co"># Verify: manual application of ar_plan matches predict output</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>CV safety test:</strong></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"AR estimation does not leak information across CV folds"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Run blocked CV with ar_order=1</span></span>
<span>  <span class="co"># Verify: each fold estimates AR from training data only</span></span>
<span>  <span class="co"># Verify: test AR params != training AR params (different data)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Backward compatibility:</strong></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"ar_order=NULL or 0 reproduces old behavior exactly"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Fit with ar_order=0</span></span>
<span>  <span class="co"># Fit without ar_order (old API)</span></span>
<span>  <span class="co"># Check: W, P, b identical</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
</ol></div>
<div class="section level3">
<h3 id="id_53-phase-3-documentation--examples-week-2">5.3 Phase 3: Documentation &amp; Examples (Week 2)<a class="anchor" aria-label="anchor" href="#id_53-phase-3-documentation--examples-week-2"></a></h3>
<p><strong>Update roxygen docs:</strong></p>
<ol style="list-style-type: decimal"><li>
<p><strong><code>R/fit.R</code>:</strong></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @param ar_order AR order for prewhitening (default: 1).</span></span>
<span><span class="co">#'   Set to 0 or NULL to disable.</span></span>
<span><span class="co">#' @param ar_method AR estimation method: "ar" (Yule-Walker) or</span></span>
<span><span class="co">#'   "arma" (Hannan-Rissanen). Default: "ar".</span></span>
<span><span class="co">#' @param ar_pooling Spatial pooling for AR: "global" (one AR for all voxels),</span></span>
<span><span class="co">#'   "run" (separate AR per run). Default: "run".</span></span></code></pre></div>
</li>
<li>
<p><strong>Vignette:</strong> <code>vignettes/ar-prewhitening.Rmd</code></p>
<ul><li>When to use AR prewhitening</li>
<li>Impact on decoder performance</li>
<li>Choosing AR order (BIC, AIC, or fixed)</li>
<li>Computational cost considerations</li>
</ul></li>
<li>
<p><strong>README update:</strong></p>
<ul><li>Add AR prewhitening to feature list</li>
<li>Simple example with/without AR</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="id_54-phase-4-performance-optimization-week-3">5.4 Phase 4: Performance Optimization (Week 3)<a class="anchor" aria-label="anchor" href="#id_54-phase-4-performance-optimization-week-3"></a></h3>
<p><strong>Potential optimizations:</strong></p>
<ol style="list-style-type: decimal"><li>
<p><strong>Parallel AR estimation across voxels:</strong></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plan</span> <span class="op">&lt;-</span> <span class="fu">fmriAR</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmriAR/reference/fit_noise.html" class="external-link">fit_noise</a></span><span class="op">(</span><span class="va">...</span>, threads <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="co"># Enable OpenMP</span></span></code></pre></div>
</li>
<li>
<p><strong>Cache AR plan for repeated fits:</strong></p>
<ul><li>If fitting multiple ROIs with same run structure, reuse AR plan</li>
</ul></li>
<li>
<p><strong>Auto AR order selection:</strong></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ar_order</span> <span class="op">=</span> <span class="st">"auto"</span>  <span class="co"># Use BIC to select p ∈ {0, 1, 2, 3}</span></span></code></pre></div>
</li>
<li>
<p><strong>Benchmark comparison:</strong></p>
<ul><li>Compare runtime with/without AR</li>
<li>Measure impact on searchlight analysis</li>
</ul></li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="id_6-testing-strategy">6. Testing Strategy<a class="anchor" aria-label="anchor" href="#id_6-testing-strategy"></a></h2>
<div class="section level3">
<h3 id="id_61-unit-tests">6.1 Unit Tests<a class="anchor" aria-label="anchor" href="#id_61-unit-tests"></a></h3>
<p><strong>File:</strong> <code>tests/testthat/test-ar-prewhitening.R</code></p>
<p><strong>Coverage goals:</strong></p>
<ul><li>✓ AR estimation reduces autocorrelation</li>
<li>✓ Run-specific AR parameters</li>
<li>✓ Train/test consistency</li>
<li>✓ CV fold independence</li>
<li>✓ Backward compatibility (ar_order=0)</li>
<li>✓ Error handling (bad inputs)</li>
</ul></div>
<div class="section level3">
<h3 id="id_62-integration-tests">6.2 Integration Tests<a class="anchor" aria-label="anchor" href="#id_62-integration-tests"></a></h3>
<p><strong>File:</strong> <code>tests/testthat/test-rmvpa-integration.R</code></p>
<p><strong>Coverage goals:</strong></p>
<ul><li>✓ rMVPA model spec with AR parameters</li>
<li>✓ Searchlight with AR prewhitening</li>
<li>✓ Blocked CV with AR</li>
<li>✓ Performance metrics unchanged by AR (or improved)</li>
</ul></div>
<div class="section level3">
<h3 id="id_63-simulation-studies">6.3 Simulation Studies<a class="anchor" aria-label="anchor" href="#id_63-simulation-studies"></a></h3>
<p><strong>Validate AR improves decoder performance:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong>Scenario 1:</strong> High autocorrelation (ρ = 0.5)
<ul><li>Expected: AR prewhitening improves accuracy</li>
</ul></li>
<li>
<strong>Scenario 2:</strong> Low autocorrelation (ρ = 0.1)
<ul><li>Expected: AR has minimal impact</li>
</ul></li>
<li>
<strong>Scenario 3:</strong> Multi-run with varying AR
<ul><li>Expected: Run-specific AR outperforms global</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="id_64-real-data-validation">6.4 Real Data Validation<a class="anchor" aria-label="anchor" href="#id_64-real-data-validation"></a></h3>
<p><strong>Apply to existing fMRI datasets:</strong></p>
<ol style="list-style-type: decimal"><li>Check residual whiteness (ACF diagnostics)</li>
<li>Compare decoder accuracy with/without AR</li>
<li>Measure computational overhead</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="id_7-performance-considerations">7. Performance Considerations<a class="anchor" aria-label="anchor" href="#id_7-performance-considerations"></a></h2>
<div class="section level3">
<h3 id="id_71-computational-cost">7.1 Computational Cost<a class="anchor" aria-label="anchor" href="#id_71-computational-cost"></a></h3>
<p><strong>AR estimation:</strong> - <strong>Per voxel:</strong> O(p² T) for Yule-Walker (fast) - <strong>Parallelized:</strong> OpenMP across voxels - <strong>Typical:</strong> ~0.1-0.5 seconds for 100 TRs × 1000 voxels</p>
<p><strong>Whitening:</strong> - <strong>Per voxel:</strong> O(p T) recursive filtering - <strong>Parallelized:</strong> OpenMP across voxels - <strong>Typical:</strong> ~0.05-0.2 seconds for same data</p>
<p><strong>Impact on searchlight:</strong> - <strong>Overhead:</strong> +5-10% runtime (negligible vs. decoder fitting) - <strong>Benefit:</strong> More efficient decoder (better GLS weights)</p>
</div>
<div class="section level3">
<h3 id="id_72-memory-usage">7.2 Memory Usage<a class="anchor" aria-label="anchor" href="#id_72-memory-usage"></a></h3>
<p><strong>AR plan storage:</strong> - Global pooling: O(p) parameters - Run pooling: O(R × p) where R = number of runs - Parcel pooling: O(P × p) where P = number of parcels</p>
<p><strong>Typical footprint:</strong> &lt;1 MB for most analyses</p>
</div>
<div class="section level3">
<h3 id="id_73-scaling-recommendations">7.3 Scaling Recommendations<a class="anchor" aria-label="anchor" href="#id_73-scaling-recommendations"></a></h3>
<p><strong>For large searchlights (V &gt; 10,000):</strong> - Use <code>ar_pooling = "global"</code> to reduce AR estimation cost - Enable OpenMP parallelization in fmriAR</p>
<p><strong>For many runs (R &gt; 10):</strong> - Use <code>ar_pooling = "run"</code> for run-specific noise structure - Consider caching AR plans across ROIs with same run structure</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_8-open-questions--future-enhancements">8. Open Questions &amp; Future Enhancements<a class="anchor" aria-label="anchor" href="#id_8-open-questions--future-enhancements"></a></h2>
<div class="section level3">
<h3 id="id_81-open-questions">8.1 Open Questions<a class="anchor" aria-label="anchor" href="#id_81-open-questions"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Should AR order be auto-selected via BIC?</strong>
<ul><li>Pro: Automatic, data-driven</li>
<li>Con: Adds complexity, computational cost</li>
</ul></li>
<li>
<strong>Should we support ARMA(p, q) models?</strong>
<ul><li>Pro: More flexible noise modeling</li>
<li>Con: Slower estimation, more parameters</li>
</ul></li>
<li>
<strong>Should AR be applied to design matrix (DBbeta)?</strong>
<ul><li>Current: Only Y is whitened</li>
<li>Alternative: Whiten both Y and DBbeta prior</li>
<li>Trade-off: Computational cost vs. theoretical correctness</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="id_82-future-enhancements">8.2 Future Enhancements<a class="anchor" aria-label="anchor" href="#id_82-future-enhancements"></a></h3>
<ol style="list-style-type: decimal"><li>
<p><strong>Parcel-based AR pooling:</strong></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>ar_pooling <span class="ot">=</span> <span class="st">"parcel"</span>,</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>parcels <span class="ot">=</span> parcel_labels  <span class="co"># Spatial pooling of AR</span></span></code></pre></div>
</li>
<li>
<p><strong>Multi-scale AR:</strong></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>ar_pooling <span class="ot">=</span> <span class="st">"multiscale"</span>,</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>parcel_sets <span class="ot">=</span> <span class="fu">list</span>(coarse, medium, fine)</span></code></pre></div>
</li>
<li>
<p><strong>AR diagnostics:</strong></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">ar_acf</span>  <span class="co"># Post-whitening ACF</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">ar_bic</span>  <span class="co"># BIC per AR order</span></span></code></pre></div>
</li>
<li>
<p><strong>Prewhitened prior:</strong></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Whiten DBbeta prior along with Y</span></span>
<span><span class="va">DBbeta_white</span> <span class="op">&lt;-</span> <span class="fu">whiten_apply</span><span class="op">(</span><span class="va">plan</span>, <span class="cn">NULL</span>, <span class="va">DBbeta</span><span class="op">)</span><span class="op">$</span><span class="va">Y</span></span></code></pre></div>
</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="id_9-summary--recommendations">9. Summary &amp; Recommendations<a class="anchor" aria-label="anchor" href="#id_9-summary--recommendations"></a></h2>
<div class="section level3">
<h3 id="id_91-key-decisions">9.1 Key Decisions<a class="anchor" aria-label="anchor" href="#id_91-key-decisions"></a></h3>
<table class="table"><colgroup><col width="27%"><col width="43%"><col width="29%"></colgroup><thead><tr><th>Decision</th>
<th>Recommendation</th>
<th>Rationale</th>
</tr></thead><tbody><tr><td><strong>AR library</strong></td>
<td>Use fmriAR</td>
<td>Production-ready, run-aware, fast C++</td>
</tr><tr><td><strong>Integration point</strong></td>
<td>After baseline, before standardization</td>
<td>Estimates AR on residuals, cleanly separable</td>
</tr><tr><td><strong>AR pooling</strong></td>
<td>Default: <code>"run"</code>
</td>
<td>Respects run-specific noise structure</td>
</tr><tr><td><strong>AR order</strong></td>
<td>Default: <code>1</code> (AR(1))</td>
<td>Simple, covers most fMRI autocorrelation</td>
</tr><tr><td><strong>rMVPA integration</strong></td>
<td>Per-fold preprocessing in <code><a href="http://bbuchsbaum.github.io/rMVPA/reference/train_model.html" class="external-link">train_model()</a></code>
</td>
<td>CV-safe, no test leakage</td>
</tr><tr><td><strong>Backward compatibility</strong></td>
<td>
<code>ar_order = NULL</code> disables AR</td>
<td>Preserves existing API</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="id_92-implementation-checklist">9.2 Implementation Checklist<a class="anchor" aria-label="anchor" href="#id_92-implementation-checklist"></a></h3>
<ul class="task-list"><li>
<label><input type="checkbox"><strong>Phase 1: Core integration</strong> (Week 1)</label>
<ul class="task-list"><li><label><input type="checkbox">Modify <code>R/fit.R</code> (add AR prewhitening)</label></li>
<li><label><input type="checkbox">Modify <code>R/predict.R</code> (apply AR to test)</label></li>
<li><label><input type="checkbox">Modify <code>R/hrfdecoder_model.R</code> (pass AR params)</label></li>
<li><label><input type="checkbox">Update <code>DESCRIPTION</code> (add fmriAR dependency)</label></li>
<li><label><input type="checkbox">Update <code>NAMESPACE</code> (import fmriAR functions)</label></li>
</ul></li>
<li>
<label><input type="checkbox"><strong>Phase 2: Testing</strong> (Week 1-2)</label>
<ul class="task-list"><li><label><input type="checkbox">Unit tests for AR estimation</label></li>
<li><label><input type="checkbox">Integration tests with rMVPA</label></li>
<li><label><input type="checkbox">Simulation studies (varying ρ)</label></li>
<li><label><input type="checkbox">Real data validation</label></li>
</ul></li>
<li>
<label><input type="checkbox"><strong>Phase 3: Documentation</strong> (Week 2)</label>
<ul class="task-list"><li><label><input type="checkbox">Roxygen docs for new parameters</label></li>
<li><label><input type="checkbox">Vignette on AR prewhitening</label></li>
<li><label><input type="checkbox">Update README examples</label></li>
</ul></li>
<li>
<label><input type="checkbox"><strong>Phase 4: Optimization</strong> (Week 3)</label>
<ul class="task-list"><li><label><input type="checkbox">Enable OpenMP parallelization</label></li>
<li><label><input type="checkbox">Benchmark performance</label></li>
<li><label><input type="checkbox">Profile memory usage</label></li>
</ul></li>
</ul></div>
<div class="section level3">
<h3 id="id_93-expected-benefits">9.3 Expected Benefits<a class="anchor" aria-label="anchor" href="#id_93-expected-benefits"></a></h3>
<p><strong>Statistical:</strong> - ✓ Correct effective degrees of freedom - ✓ Valid confidence intervals - ✓ Optimal GLS decoder weights</p>
<p><strong>Practical:</strong> - ✓ Improved decoder efficiency (less data needed) - ✓ Better generalization to test data - ✓ More accurate performance estimates</p>
<p><strong>Computational:</strong> - ✓ Minimal overhead (~5-10% runtime) - ✓ Parallelized AR estimation - ✓ Efficient recursive whitening</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="appendix-a-code-snippets">Appendix A: Code Snippets<a class="anchor" aria-label="anchor" href="#appendix-a-code-snippets"></a></h2>
<div class="section level3">
<h3 id="a1-complete-fit_hrfdecoder-with-ar">A.1 Complete fit_hrfdecoder() with AR<a class="anchor" aria-label="anchor" href="#a1-complete-fit_hrfdecoder-with-ar"></a></h3>
<p>See Section 4.2 for full implementation.</p>
</div>
<div class="section level3">
<h3 id="a2-complete-predict_hrfdecoder-with-ar">A.2 Complete predict_hrfdecoder() with AR<a class="anchor" aria-label="anchor" href="#a2-complete-predict_hrfdecoder-with-ar"></a></h3>
<p>See Section 4.3 for full implementation.</p>
</div>
<div class="section level3">
<h3 id="a3-example-usage">A.3 Example Usage<a class="anchor" aria-label="anchor" href="#a3-example-usage"></a></h3>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">hrfdecoder</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbuchsbaum/fmridesign" class="external-link">fmridesign</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/" class="external-link">fmrihrf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Create event model</span></span>
<span><span class="va">ev_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/event_model.html" class="external-link">event_model</a></span><span class="op">(</span></span>
<span>  <span class="va">onsets</span> <span class="op">~</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/hrf.html" class="external-link">hrf</a></span><span class="op">(</span><span class="va">condition</span>, basis <span class="op">=</span> <span class="st">"spmg3"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">events_df</span>,</span>
<span>  block <span class="op">=</span> <span class="op">~</span> <span class="va">run</span>,</span>
<span>  sampling_frame <span class="op">=</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/sampling_frame.html" class="external-link">sampling_frame</a></span><span class="op">(</span>blocklens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">200</span>, <span class="fl">200</span><span class="op">)</span>, TR <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Create baseline model (nuisance)</span></span>
<span><span class="va">base_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/baseline_model.html" class="external-link">baseline_model</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="va">run</span>, degree <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="va">motion_1</span> <span class="op">+</span> <span class="va">motion_2</span>,</span>
<span>  data <span class="op">=</span> <span class="va">nuisance_df</span>,</span>
<span>  block <span class="op">=</span> <span class="op">~</span> <span class="va">run</span>,</span>
<span>  sampling_frame <span class="op">=</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/sampling_frame.html" class="external-link">sampling_frame</a></span><span class="op">(</span>blocklens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">200</span>, <span class="fl">200</span><span class="op">)</span>, TR <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Fit decoder with AR(1) prewhitening</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">roi_data</span>,                 <span class="co"># (600 TRs × 500 voxels)</span></span>
<span>  ev_model <span class="op">=</span> <span class="va">ev_model</span>,</span>
<span>  base_model <span class="op">=</span> <span class="va">base_model</span>,</span>
<span>  hrf <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu">spmg3</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  ar_order <span class="op">=</span> <span class="fl">1</span>,                 <span class="co"># NEW: Enable AR(1) prewhitening</span></span>
<span>  ar_method <span class="op">=</span> <span class="st">"ar"</span>,             <span class="co"># Yule-Walker estimation</span></span>
<span>  ar_pooling <span class="op">=</span> <span class="st">"run"</span>,           <span class="co"># Run-specific AR parameters</span></span>
<span>  lambda_W <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  lambda_HRF <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  lambda_smooth <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Predict on test data</span></span>
<span><span class="va">preds_tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/predict_hrfdecoder.html">predict_hrfdecoder</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">Y_test</span>, mode <span class="op">=</span> <span class="st">"tr"</span><span class="op">)</span></span>
<span><span class="va">preds_trial</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/predict_hrfdecoder.html">predict_hrfdecoder</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">Y_test</span>, ev_model_test <span class="op">=</span> <span class="va">ev_model_test</span>,</span>
<span>                                  mode <span class="op">=</span> <span class="st">"trial"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5. Inspect AR parameters</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">preproc</span><span class="op">$</span><span class="va">ar_plan</span><span class="op">$</span><span class="va">phi</span>    <span class="co"># List of AR coefficients per run</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">settings</span><span class="op">$</span><span class="va">ar_order</span>       <span class="co"># AR order used</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="a4-rmvpa-usage">A.4 rMVPA Usage<a class="anchor" aria-label="anchor" href="#a4-rmvpa-usage"></a></h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bbuchsbaum.github.io/rMVPA/" class="external-link">rMVPA</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">hrfdecoder</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Create design</span></span>
<span><span class="va">mvdes</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/continuous_mvpa_design.html">continuous_mvpa_design</a></span><span class="op">(</span></span>
<span>  event_model <span class="op">=</span> <span class="va">ev_model</span>,</span>
<span>  block_var <span class="op">=</span> <span class="va">run_ids</span>,</span>
<span>  design_df_events <span class="op">=</span> <span class="va">trials_df</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Specify model with AR</span></span>
<span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hrfdecoder_model.html">hrfdecoder_model</a></span><span class="op">(</span></span>
<span>  dataset <span class="op">=</span> <span class="fu">as_mvpa_dataset</span><span class="op">(</span><span class="va">fmri_dataset</span><span class="op">)</span>,</span>
<span>  design <span class="op">=</span> <span class="va">mvdes</span>,</span>
<span>  basis <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu">spmg3</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  ar_order <span class="op">=</span> <span class="fl">1</span>,              <span class="co"># NEW</span></span>
<span>  ar_method <span class="op">=</span> <span class="st">"ar"</span>,          <span class="co"># NEW</span></span>
<span>  ar_pooling <span class="op">=</span> <span class="st">"run"</span>,        <span class="co"># NEW</span></span>
<span>  lambda_W <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  lambda_HRF <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  lambda_smooth <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Run searchlight with AR prewhitening</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/run_searchlight.html" class="external-link">run_searchlight</a></span><span class="op">(</span><span class="va">spec</span>, radius <span class="op">=</span> <span class="fl">8</span>, method <span class="op">=</span> <span class="st">"randomized"</span>, niter <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="appendix-b-references">Appendix B: References<a class="anchor" aria-label="anchor" href="#appendix-b-references"></a></h2>
<div class="section level3">
<h3 id="b1-package-locations">B.1 Package Locations<a class="anchor" aria-label="anchor" href="#b1-package-locations"></a></h3>
<ul><li>
<strong>hrfdecoder:</strong> <code>/Users/bbuchsbaum/code/hrfdecoder</code>
</li>
<li>
<strong>fmriAR:</strong> <code>/Users/bbuchsbaum/code/fmriAR</code>
</li>
<li>
<strong>rMVPA:</strong> <code>/Users/bbuchsbaum/code/rMVPA</code>
</li>
</ul></div>
<div class="section level3">
<h3 id="b2-key-files-modified">B.2 Key Files Modified<a class="anchor" aria-label="anchor" href="#b2-key-files-modified"></a></h3>
<table class="table"><thead><tr><th>File</th>
<th>Lines</th>
<th>Changes</th>
</tr></thead><tbody><tr><td><code>R/fit.R</code></td>
<td>40-42</td>
<td>Insert AR prewhitening</td>
</tr><tr><td><code>R/predict.R</code></td>
<td>21-27</td>
<td>Apply AR to test data</td>
</tr><tr><td><code>R/hrfdecoder_model.R</code></td>
<td>10-25</td>
<td>Add AR parameters</td>
</tr><tr><td><code>DESCRIPTION</code></td>
<td>—</td>
<td>Add fmriAR dependency</td>
</tr><tr><td><code>tests/testthat/test-ar-prewhitening.R</code></td>
<td>NEW</td>
<td>AR unit tests</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="b3-related-documentation">B.3 Related Documentation<a class="anchor" aria-label="anchor" href="#b3-related-documentation"></a></h3>
<ul><li>fmriAR vignette: <a href="https://github.com/bbuchsbaum/fmriAR/blob/main/vignettes/fmriAR-introduction.Rmd" class="external-link">fmriAR-introduction.Rmd</a>
</li>
<li>rMVPA model plugin guide: <a href="https://github.com/bbuchsbaum/rMVPA/blob/master/vignettes/custom-models.Rmd" class="external-link">custom-models.Rmd</a>
</li>
<li>hrfdecoder design notes: <a href="../notes/hrf_weakly_supervised_decoder.html">notes/hrf_weakly_supervised_decoder.md</a>
</li>
</ul><hr><p><strong>END OF INTEGRATION PLAN</strong></p>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Your Name.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

