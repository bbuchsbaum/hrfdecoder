<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>AR Prewhitening Implementation Summary ‚Ä¢ hrfdecode</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="AR Prewhitening Implementation Summary"><style>
:root {
  --albers-bg: #fff;
  --albers-fg: #111;
  --albers-accent: #1f6feb;
}
</style></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">hrfdecode</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="articles/01-getting-started.html">Getting started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>How-tos</h6></li>
    <li><a class="dropdown-item" href="articles/02-ar-prewhitening.html">AR prewhitening</a></li>
    <li><a class="dropdown-item" href="articles/03-rmvpa-integration.html">rMVPA integration</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Explanations</h6></li>
    <li><a class="dropdown-item" href="articles/04-hrf-estimation.html">HRF estimation</a></li>
    <li><a class="dropdown-item" href="articles/05-weakly-supervised.html">Weakly supervised learning</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>AR Prewhitening Implementation Summary</h1>

    </div>

<div id="ar-prewhitening-implementation-summary" class="section level1">

<p><strong>Date:</strong> 2025-11-09 <strong>Status:</strong> ‚úÖ Implementation Complete</p>
<hr><div class="section level2">
<h2 id="changes-made">Changes Made<a class="anchor" aria-label="anchor" href="#changes-made"></a></h2>
<div class="section level3">
<h3 id="id_1-package-dependencies">1. Package Dependencies<a class="anchor" aria-label="anchor" href="#id_1-package-dependencies"></a></h3>
<p><strong>Files Modified:</strong> - <a href="DESCRIPTION">DESCRIPTION</a> - Added <code>fmriAR (&gt;= 0.3.0)</code> to Imports and Remotes - <a href="NAMESPACE">NAMESPACE</a> - Added imports for <code><a href="https://bbuchsbaum.github.io/fmriAR/reference/fit_noise.html" class="external-link">fmriAR::fit_noise</a></code> and <code><a href="https://bbuchsbaum.github.io/fmriAR/reference/whiten_apply.html" class="external-link">fmriAR::whiten_apply</a></code></p>
</div>
<div class="section level3">
<h3 id="id_2-core-fitting-function">2. Core Fitting Function<a class="anchor" aria-label="anchor" href="#id_2-core-fitting-function"></a></h3>
<p><strong>File:</strong> <a href="R/fit.R">R/fit.R</a></p>
<p><strong>New Parameters:</strong> - <code>ar_order</code> - AR order for prewhitening (default: <code>NULL</code> for no AR). Set to <code>1</code> for AR(1), <code>2</code> for AR(2), or <code>"auto"</code> for automatic BIC-based selection - <code>ar_method</code> - AR estimation method: <code>"ar"</code> (Yule-Walker) or <code>"arma"</code> (Hannan-Rissanen). Default: <code>"ar"</code> - <code>ar_pooling</code> - Spatial pooling: <code>"global"</code> (one AR model) or <code>"run"</code> (per-run AR). Default: <code>"run"</code></p>
<p><strong>Implementation Details:</strong> - AR prewhitening inserted between baseline residualization (line 52) and standardization (line 81) - AR plan estimated from residuals using <code><a href="https://bbuchsbaum.github.io/fmriAR/reference/fit_noise.html" class="external-link">fmriAR::fit_noise()</a></code> - Whitening applied via <code><a href="https://bbuchsbaum.github.io/fmriAR/reference/whiten_apply.html" class="external-link">fmriAR::whiten_apply()</a></code> - AR plan stored in <code>fit$preproc$ar_plan</code> for test application - AR settings stored in <code>fit$settings</code> (ar_order, ar_method, ar_pooling)</p>
<p><strong>Code Flow:</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fl">1.</span> Baseline residualization  ‚Üí Remove nuisance signals</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fl">2.</span> AR <span class="fu">prewhitening</span> (NEW)     ‚Üí Remove temporal autocorrelation</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fl">3.</span> Standardization           ‚Üí Z<span class="sc">-</span>score normalization</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fl">4.</span> Decoder preparation       ‚Üí Build priors, Laplacian</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fl">5.</span> ALS solver                ‚Üí Fit W, P, HRF</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_3-prediction-function">3. Prediction Function<a class="anchor" aria-label="anchor" href="#id_3-prediction-function"></a></h3>
<p><strong>File:</strong> <a href="R/predict.R">R/predict.R</a></p>
<p><strong>Changes:</strong> - AR prewhitening applied to test data BEFORE standardization (lines 24-33) - Uses stored <code>fit$preproc$ar_plan</code> from training - New helper function <code><a href="reference/dot-get_run_ids_from_test_data.html">.get_run_ids_from_test_data()</a></code> (lines 107-122) extracts run IDs for test data from: 1. <code>ev_model_test</code> if provided 2. Training run_ids if test length matches 3. Default to single run otherwise</p>
<p><strong>Preprocessing Order in Predict:</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fl">1.</span> AR prewhitening  ‚Üí Apply stored ar_plan from training</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fl">2.</span> Standardization  ‚Üí Apply stored center<span class="sc">/</span>scale from training</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="fl">3.</span> Prediction       ‚Üí Compute soft labels</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_4-rmvpa-integration">4. rMVPA Integration<a class="anchor" aria-label="anchor" href="#id_4-rmvpa-integration"></a></h3>
<p><strong>File:</strong> <a href="R/hrfdecoder_model.R">R/hrfdecoder_model.R</a></p>
<p><strong>Changes:</strong> - Added AR parameters to <code><a href="reference/hrfdecoder_model.html">hrfdecoder_model()</a></code> signature (lines 16-18) - Default: <code>ar_order = 1</code> (enables AR(1) by default for rMVPA) - AR parameters passed through to <code><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder()</a></code> in <code>train_model.hrfdecoder_model()</code> (lines 75-77)</p>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hrfdecoder_model.html">hrfdecoder_model</a></span><span class="op">(</span></span>
<span>  dataset <span class="op">=</span> <span class="va">dset</span>,</span>
<span>  design <span class="op">=</span> <span class="va">mvdes</span>,</span>
<span>  ar_order <span class="op">=</span> <span class="fl">1</span>,        <span class="co"># NEW</span></span>
<span>  ar_method <span class="op">=</span> <span class="st">"ar"</span>,    <span class="co"># NEW</span></span>
<span>  ar_pooling <span class="op">=</span> <span class="st">"run"</span>,  <span class="co"># NEW</span></span>
<span>  lambda_W <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_5-comprehensive-tests">5. Comprehensive Tests<a class="anchor" aria-label="anchor" href="#id_5-comprehensive-tests"></a></h3>
<p><strong>File:</strong> <a href="tests/testthat/test-ar-prewhitening.R">tests/testthat/test-ar-prewhitening.R</a></p>
<p><strong>Test Coverage:</strong> 1. ‚úÖ AR(1) prewhitening reduces autocorrelation 2. ‚úÖ Run-specific AR parameters estimated and applied 3. ‚úÖ AR parameters applied consistently to test data 4. ‚úÖ Backward compatibility: <code>ar_order=NULL</code> reproduces old behavior 5. ‚úÖ Auto AR order selection works 6. ‚úÖ rMVPA integration: AR parameters passed through model spec</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="usage-examples">Usage Examples<a class="anchor" aria-label="anchor" href="#usage-examples"></a></h2>
<div class="section level3">
<h3 id="standalone-usage">Standalone Usage<a class="anchor" aria-label="anchor" href="#standalone-usage"></a></h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">hrfdecoder</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbuchsbaum/fmridesign" class="external-link">fmridesign</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/" class="external-link">fmrihrf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create event model</span></span>
<span><span class="va">ev_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/event_model.html" class="external-link">event_model</a></span><span class="op">(</span></span>
<span>  <span class="va">onsets</span> <span class="op">~</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/hrf.html" class="external-link">hrf</a></span><span class="op">(</span><span class="va">condition</span>, basis <span class="op">=</span> <span class="st">"spmg3"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">events_df</span>,</span>
<span>  block <span class="op">=</span> <span class="op">~</span> <span class="va">run</span>,</span>
<span>  sampling_frame <span class="op">=</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/sampling_frame.html" class="external-link">sampling_frame</a></span><span class="op">(</span>blocklens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">200</span><span class="op">)</span>, TR <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create baseline model</span></span>
<span><span class="va">base_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/baseline_model.html" class="external-link">baseline_model</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="va">run</span>, degree <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="va">motion</span>,</span>
<span>  data <span class="op">=</span> <span class="va">nuisance_df</span>,</span>
<span>  block <span class="op">=</span> <span class="op">~</span> <span class="va">run</span>,</span>
<span>  sampling_frame <span class="op">=</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/sampling_frame.html" class="external-link">sampling_frame</a></span><span class="op">(</span>blocklens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">200</span><span class="op">)</span>, TR <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit decoder WITH AR(1) prewhitening</span></span>
<span><span class="va">fit_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">roi_data</span>,              <span class="co"># (400 TRs √ó 500 voxels)</span></span>
<span>  ev_model <span class="op">=</span> <span class="va">ev_model</span>,</span>
<span>  base_model <span class="op">=</span> <span class="va">base_model</span>,</span>
<span>  ar_order <span class="op">=</span> <span class="fl">1</span>,              <span class="co"># Enable AR(1) prewhitening</span></span>
<span>  ar_method <span class="op">=</span> <span class="st">"ar"</span>,          <span class="co"># Yule-Walker estimation</span></span>
<span>  ar_pooling <span class="op">=</span> <span class="st">"run"</span>,        <span class="co"># Run-specific AR parameters</span></span>
<span>  lambda_W <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  lambda_HRF <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  lambda_smooth <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit decoder WITHOUT AR (backward compatible)</span></span>
<span><span class="va">fit_no_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">roi_data</span>,</span>
<span>  ev_model <span class="op">=</span> <span class="va">ev_model</span>,</span>
<span>  base_model <span class="op">=</span> <span class="va">base_model</span>,</span>
<span>  ar_order <span class="op">=</span> <span class="cn">NULL</span>,           <span class="co"># Disable AR prewhitening</span></span>
<span>  lambda_W <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  lambda_HRF <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  lambda_smooth <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predict on test data (AR automatically applied if used in training)</span></span>
<span><span class="va">preds_tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/predict_hrfdecoder.html">predict_hrfdecoder</a></span><span class="op">(</span><span class="va">fit_ar</span>, <span class="va">Y_test</span>, mode <span class="op">=</span> <span class="st">"tr"</span><span class="op">)</span></span>
<span><span class="va">preds_trial</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/predict_hrfdecoder.html">predict_hrfdecoder</a></span><span class="op">(</span><span class="va">fit_ar</span>, <span class="va">Y_test</span>,</span>
<span>                                  ev_model_test <span class="op">=</span> <span class="va">ev_model_test</span>,</span>
<span>                                  mode <span class="op">=</span> <span class="st">"trial"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect AR parameters</span></span>
<span><span class="va">fit_ar</span><span class="op">$</span><span class="va">preproc</span><span class="op">$</span><span class="va">ar_plan</span>        <span class="co"># fmriAR plan object</span></span>
<span><span class="va">fit_ar</span><span class="op">$</span><span class="va">settings</span><span class="op">$</span><span class="va">ar_order</span>       <span class="co"># AR order used (1)</span></span>
<span><span class="va">fit_ar</span><span class="op">$</span><span class="va">settings</span><span class="op">$</span><span class="va">ar_pooling</span>     <span class="co"># Pooling method ("run")</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="rmvpa-usage">rMVPA Usage<a class="anchor" aria-label="anchor" href="#rmvpa-usage"></a></h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bbuchsbaum.github.io/rMVPA/" class="external-link">rMVPA</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">hrfdecoder</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create design</span></span>
<span><span class="va">mvdes</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/continuous_mvpa_design.html">continuous_mvpa_design</a></span><span class="op">(</span></span>
<span>  event_model <span class="op">=</span> <span class="va">ev_model</span>,</span>
<span>  block_var <span class="op">=</span> <span class="va">run_ids</span>,</span>
<span>  design_df_events <span class="op">=</span> <span class="va">trials_df</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify model WITH AR prewhitening</span></span>
<span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hrfdecoder_model.html">hrfdecoder_model</a></span><span class="op">(</span></span>
<span>  dataset <span class="op">=</span> <span class="fu">as_mvpa_dataset</span><span class="op">(</span><span class="va">fmri_dataset</span><span class="op">)</span>,</span>
<span>  design <span class="op">=</span> <span class="va">mvdes</span>,</span>
<span>  basis <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu">spmg3</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  ar_order <span class="op">=</span> <span class="fl">1</span>,              <span class="co"># AR(1) prewhitening</span></span>
<span>  ar_method <span class="op">=</span> <span class="st">"ar"</span>,          <span class="co"># Yule-Walker</span></span>
<span>  ar_pooling <span class="op">=</span> <span class="st">"run"</span>,        <span class="co"># Run-specific</span></span>
<span>  lambda_W <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  lambda_HRF <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  lambda_smooth <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run searchlight with AR prewhitening</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/run_searchlight.html" class="external-link">run_searchlight</a></span><span class="op">(</span><span class="va">spec</span>, radius <span class="op">=</span> <span class="fl">8</span>, method <span class="op">=</span> <span class="st">"randomized"</span>, niter <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify model WITHOUT AR</span></span>
<span><span class="va">spec_no_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hrfdecoder_model.html">hrfdecoder_model</a></span><span class="op">(</span></span>
<span>  dataset <span class="op">=</span> <span class="fu">as_mvpa_dataset</span><span class="op">(</span><span class="va">fmri_dataset</span><span class="op">)</span>,</span>
<span>  design <span class="op">=</span> <span class="va">mvdes</span>,</span>
<span>  ar_order <span class="op">=</span> <span class="cn">NULL</span>,           <span class="co"># Disable AR</span></span>
<span>  lambda_W <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="auto-ar-order-selection">Auto AR Order Selection<a class="anchor" aria-label="anchor" href="#auto-ar-order-selection"></a></h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Let fmriAR automatically select AR order via BIC</span></span>
<span><span class="va">fit_auto</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">roi_data</span>,</span>
<span>  ev_model <span class="op">=</span> <span class="va">ev_model</span>,</span>
<span>  ar_order <span class="op">=</span> <span class="st">"auto"</span>,         <span class="co"># Automatic order selection</span></span>
<span>  ar_pooling <span class="op">=</span> <span class="st">"global"</span>,     <span class="co"># Global AR for speed</span></span>
<span>  lambda_W <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check selected order</span></span>
<span><span class="va">fit_auto</span><span class="op">$</span><span class="va">preproc</span><span class="op">$</span><span class="va">ar_plan</span><span class="op">$</span><span class="va">order</span><span class="op">[</span><span class="st">"p"</span><span class="op">]</span>  <span class="co"># Selected AR order (e.g., 2)</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="key-design-decisions">Key Design Decisions<a class="anchor" aria-label="anchor" href="#key-design-decisions"></a></h2>
<div class="section level3">
<h3 id="id_1-preprocessing-order">1. Preprocessing Order<a class="anchor" aria-label="anchor" href="#id_1-preprocessing-order"></a></h3>
<p><strong>Chosen:</strong> Baseline ‚Üí AR ‚Üí Standardization</p>
<p><strong>Rationale:</strong> - Baseline removal first eliminates structured nuisance before AR estimation - AR operates on residuals (after nuisance removal) - Standardization applied to whitened residuals for consistent scaling</p>
</div>
<div class="section level3">
<h3 id="id_2-ar-parameter-storage">2. AR Parameter Storage<a class="anchor" aria-label="anchor" href="#id_2-ar-parameter-storage"></a></h3>
<p><strong>Location:</strong> <code>fit$preproc$ar_plan</code></p>
<p><strong>Rationale:</strong> - Consistent with existing preprocessing storage (<code>center</code>, <code>scale</code>) - Complete fmriAR plan object enables identical test application - No information loss (full AR state preserved)</p>
</div>
<div class="section level3">
<h3 id="id_3-run-specific-vs-global-ar">3. Run-Specific vs.¬†Global AR<a class="anchor" aria-label="anchor" href="#id_3-run-specific-vs-global-ar"></a></h3>
<p><strong>Default:</strong> <code>ar_pooling = "run"</code></p>
<p><strong>Rationale:</strong> - fMRI noise often varies across runs (scanner drift, subject state) - Run-specific AR respects this heterogeneity - Laplacian already blocks smoothing across runs (consistent design)</p>
</div>
<div class="section level3">
<h3 id="id_4-rmvpa-default">4. rMVPA Default<a class="anchor" aria-label="anchor" href="#id_4-rmvpa-default"></a></h3>
<p><strong>Default:</strong> <code>ar_order = 1</code> in <code><a href="reference/hrfdecoder_model.html">hrfdecoder_model()</a></code></p>
<p><strong>Rationale:</strong> - Most fMRI data exhibits AR(1) autocorrelation - Enables prewhitening by default for rMVPA users - Can be disabled with <code>ar_order = NULL</code> if not desired</p>
</div>
<div class="section level3">
<h3 id="id_5-backward-compatibility">5. Backward Compatibility<a class="anchor" aria-label="anchor" href="#id_5-backward-compatibility"></a></h3>
<p><strong>Mechanism:</strong> <code>ar_order = NULL</code> (default in standalone <code><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder()</a></code>)</p>
<p><strong>Guarantees:</strong> - Existing code without AR parameters runs unchanged - <code>ar_order = NULL</code> or <code>ar_order = 0</code> produces identical results to pre-AR code - No breaking changes to API</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="performance-characteristics">Performance Characteristics<a class="anchor" aria-label="anchor" href="#performance-characteristics"></a></h2>
<div class="section level3">
<h3 id="computational-cost">Computational Cost<a class="anchor" aria-label="anchor" href="#computational-cost"></a></h3>
<p><strong>AR Estimation:</strong> - <strong>Algorithm:</strong> Yule-Walker (default) or Hannan-Rissanen - <strong>Complexity:</strong> O(p¬≤ T V) for p AR order, T TRs, V voxels - <strong>Typical:</strong> ~0.1-0.5 seconds for 200 TRs √ó 1000 voxels</p>
<p><strong>Whitening:</strong> - <strong>Algorithm:</strong> Recursive filtering via C++/RcppArmadillo - <strong>Complexity:</strong> O(p T V) - <strong>Typical:</strong> ~0.05-0.2 seconds for same data - <strong>Parallelization:</strong> OpenMP across voxels (if enabled in fmriAR)</p>
<p><strong>Overhead:</strong> - <strong>Searchlight impact:</strong> +5-10% total runtime - <strong>Benefit:</strong> More efficient decoder (better GLS weights)</p>
</div>
<div class="section level3">
<h3 id="memory-usage">Memory Usage<a class="anchor" aria-label="anchor" href="#memory-usage"></a></h3>
<p><strong>AR Plan Storage:</strong> - Global pooling: O(p) parameters - Run pooling: O(R √ó p) where R = number of runs - Typical footprint: &lt;1 MB</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="testing--validation">Testing &amp; Validation<a class="anchor" aria-label="anchor" href="#testing--validation"></a></h2>
<div class="section level3">
<h3 id="unit-tests">Unit Tests<a class="anchor" aria-label="anchor" href="#unit-tests"></a></h3>
<p>All tests in <a href="tests/testthat/test-ar-prewhitening.R">tests/testthat/test-ar-prewhitening.R</a>:</p>
<ul><li>‚úÖ Decorrelation verification</li>
<li>‚úÖ Multi-run handling</li>
<li>‚úÖ Train/test consistency</li>
<li>‚úÖ Backward compatibility</li>
<li>‚úÖ Auto order selection</li>
<li>‚úÖ rMVPA integration</li>
</ul></div>
<div class="section level3">
<h3 id="recommended-validation">Recommended Validation<a class="anchor" aria-label="anchor" href="#recommended-validation"></a></h3>
<ol style="list-style-type: decimal"><li>
<p><strong>Check residual whiteness:</strong></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># After fitting with AR</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder</a></span><span class="op">(</span><span class="va">...</span>, ar_order <span class="op">=</span> <span class="fl">1</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="co"># Manually compute residuals and check ACF</span></span></code></pre></div>
</li>
<li>
<p><strong>Compare with/without AR:</strong></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder</a></span><span class="op">(</span><span class="va">...</span>, ar_order <span class="op">=</span> <span class="fl">1</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="va">fit_no_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder</a></span><span class="op">(</span><span class="va">...</span>, ar_order <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="co"># Compare decoder accuracy on held-out data</span></span></code></pre></div>
</li>
<li>
<p><strong>Verify CV safety:</strong></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In rMVPA: AR estimated from training fold only</span></span>
<span><span class="co"># Each fold uses its own AR parameters</span></span></code></pre></div>
</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="future-enhancements">Future Enhancements<a class="anchor" aria-label="anchor" href="#future-enhancements"></a></h2>
<div class="section level3">
<h3 id="potential-additions">Potential Additions<a class="anchor" aria-label="anchor" href="#potential-additions"></a></h3>
<ol style="list-style-type: decimal"><li>
<p><strong>ARMA Models:</strong></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder</a></span><span class="op">(</span><span class="va">...</span>, ar_order <span class="op">=</span> <span class="fl">1</span>, ar_method <span class="op">=</span> <span class="st">"arma"</span>, q <span class="op">=</span> <span class="fl">1</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Parcel-Based Pooling:</strong></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_hrfdecoder.html">fit_hrfdecoder</a></span><span class="op">(</span><span class="va">...</span>, ar_pooling <span class="op">=</span> <span class="st">"parcel"</span>, parcels <span class="op">=</span> <span class="va">parcel_labels</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>AR Diagnostics:</strong></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">ar_acf</span>      <span class="co"># Post-whitening ACF</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">ar_bic</span>      <span class="co"># BIC per AR order</span></span></code></pre></div>
</li>
<li>
<p><strong>Prewhitened Prior:</strong></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Currently: only Y is whitened</span></span>
<span><span class="co"># Future: whiten DBbeta prior as well</span></span></code></pre></div>
</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a></h2>
<div class="section level3">
<h3 id="updated-files">Updated Files<a class="anchor" aria-label="anchor" href="#updated-files"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong><a href="R/fit.R">R/fit.R</a></strong> - Roxygen docs for AR parameters (lines 16-22)</li>
<li>
<strong><a href="R/hrfdecoder_model.R">R/hrfdecoder_model.R</a></strong> - Roxygen docs for rMVPA AR params (lines 2-4)</li>
</ol></div>
<div class="section level3">
<h3 id="additional-documentation-needed">Additional Documentation Needed<a class="anchor" aria-label="anchor" href="#additional-documentation-needed"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Vignette:</strong> <code>vignettes/ar-prewhitening.Rmd</code>
<ul><li>When to use AR prewhitening</li>
<li>Impact on decoder performance</li>
<li>Choosing AR order</li>
<li>Computational cost</li>
</ul></li>
<li>
<strong>README Update:</strong>
<ul><li>Add AR prewhitening to feature list</li>
<li>Example with/without AR</li>
</ul></li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
<div class="section level3">
<h3 id="related-documentation">Related Documentation<a class="anchor" aria-label="anchor" href="#related-documentation"></a></h3>
<ul><li>
<strong>Integration Plan:</strong> <a href="AR_PREWHITENING_INTEGRATION_PLAN.html">AR_PREWHITENING_INTEGRATION_PLAN.md</a>
</li>
<li>
<strong>fmriAR Package:</strong> <code>/Users/bbuchsbaum/code/fmriAR</code>
</li>
<li>
<strong>Design Notes:</strong> <a href="notes/hrf_weakly_supervised_decoder.html">notes/hrf_weakly_supervised_decoder.md</a> Section 4</li>
</ul></div>
<div class="section level3">
<h3 id="key-papers">Key Papers<a class="anchor" aria-label="anchor" href="#key-papers"></a></h3>
<ul><li>Worsley et al.¬†(2002). ‚ÄúA general statistical analysis for fMRI data.‚Äù <em>NeuroImage</em>.</li>
<li>Purdon &amp; Weisskoff (1998). ‚ÄúEffect of temporal autocorrelation due to physiological noise and stimulus paradigm on voxel-level false-positive rates in fMRI.‚Äù <em>Human Brain Mapping</em>.</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="summary-checklist">Summary Checklist<a class="anchor" aria-label="anchor" href="#summary-checklist"></a></h2>
<ul><li>‚úÖ fmriAR dependency added to DESCRIPTION and NAMESPACE</li>
<li>‚úÖ AR prewhitening integrated into fit_hrfdecoder() preprocessing pipeline</li>
<li>‚úÖ AR plan stored and applied to test data in predict_hrfdecoder()</li>
<li>‚úÖ rMVPA integration: AR parameters passed through model spec</li>
<li>‚úÖ Comprehensive unit tests created</li>
<li>‚úÖ Roxygen documentation updated</li>
<li>‚úÖ Backward compatibility maintained (ar_order = NULL)</li>
<li>‚úÖ Implementation follows integration plan</li>
</ul><p><strong>Status:</strong> Ready for testing and deployment! üéâ</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Your Name.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

