<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>rMVPA Package Architecture Report: Integration Points for hrfdecoder • hrfdecode</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="rMVPA Package Architecture Report: Integration Points for hrfdecoder"><style>
:root {
  --albers-bg: #fff;
  --albers-fg: #111;
  --albers-accent: #1f6feb;
}
</style></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">hrfdecode</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="articles/01-getting-started.html">Getting started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>How-tos</h6></li>
    <li><a class="dropdown-item" href="articles/02-ar-prewhitening.html">AR prewhitening</a></li>
    <li><a class="dropdown-item" href="articles/03-rmvpa-integration.html">rMVPA integration</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Explanations</h6></li>
    <li><a class="dropdown-item" href="articles/04-hrf-estimation.html">HRF estimation</a></li>
    <li><a class="dropdown-item" href="articles/05-weakly-supervised.html">Weakly supervised learning</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>rMVPA Package Architecture Report: Integration Points for hrfdecoder</h1>

    </div>

<div id="rmvpa-package-architecture-report-integration-points-for-hrfdecoder" class="section level1">

<div class="section level2">
<h2 id="executive-summary">Executive Summary<a class="anchor" aria-label="anchor" href="#executive-summary"></a></h2>
<p>This report documents the rMVPA plugin architecture with specific focus on how the <strong>hrfdecoder</strong> decoder model integrates. The analysis covers (1) the S3 model plugin system, (2) data flow through searchlight/cross-validation pipelines, (3) existing preprocessing capabilities, and (4) architectural patterns for extending the framework.</p>
<hr></div>
<div class="section level2">
<h2 id="id_1-model-plugin-architecture">1. Model Plugin Architecture<a class="anchor" aria-label="anchor" href="#id_1-model-plugin-architecture"></a></h2>
<div class="section level3">
<h3 id="id_11-s3-method-dispatch-system">1.1 S3 Method Dispatch System<a class="anchor" aria-label="anchor" href="#id_11-s3-method-dispatch-system"></a></h3>
<p>rMVPA uses S3 classes for extensibility. Core model operations dispatch through:</p>
<p><strong>Generic Functions</strong> (defined in <code>/R/allgeneric.R</code>): - <code>train_model(obj, ...)</code> → trains model on ROI/fold data - <code>predict_model(object, fit, newdata, ...)</code> → generates predictions - <code>format_result(obj, result, error_message, context, ...)</code> → formats fold-level outputs - <code>merge_results(obj, result_set, indices, id, ...)</code> → aggregates fold results to ROI-level performance - <code>compute_performance(obj, result)</code> → extracts metrics from result</p>
</div>
<div class="section level3">
<h3 id="id_12-model-spec-creation-create_model_spec-and-mvpa_model">1.2 Model Spec Creation: <code>create_model_spec()</code> and <code>mvpa_model()</code>
<a class="anchor" aria-label="anchor" href="#id_12-model-spec-creation-create_model_spec-and-mvpa_model"></a></h3>
<p><strong>Function</strong>: <code>/R/mvpa_model.R:196-213</code> and <code>/R/mvpa_model.R:260-337</code></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">create_model_spec</span><span class="op">(</span><span class="va">name</span>, <span class="va">dataset</span>, <span class="va">design</span>, return_predictions<span class="op">=</span><span class="cn">FALSE</span>, </span>
<span>                  compute_performance<span class="op">=</span><span class="cn">FALSE</span>, tune_reps<span class="op">=</span><span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="co"># Returns: S3 object with class c(name, "model_spec", "list")</span></span>
<span></span>
<span><span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/mvpa_model.html" class="external-link">mvpa_model</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">dataset</span>, <span class="va">design</span>, model_type<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"classification"</span>, <span class="st">"regression"</span><span class="op">)</span>, </span>
<span>           crossval<span class="op">=</span><span class="cn">NULL</span>, feature_selector<span class="op">=</span><span class="cn">NULL</span>, tune_grid<span class="op">=</span><span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="co"># Returns: S3 object with class c("mvpa_model", "model_spec", "list")</span></span></code></pre></div>
<p><strong>Key Fields in Model Spec</strong>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_spec</span><span class="op">$</span><span class="va">dataset</span>          <span class="co"># mvpa_dataset with train_data, test_data, mask</span></span>
<span><span class="va">model_spec</span><span class="op">$</span><span class="va">design</span>           <span class="co"># mvpa_design with y_train, y_test, block_var</span></span>
<span><span class="va">model_spec</span><span class="op">$</span><span class="va">crossval</span>         <span class="co"># cross_validation spec (blocked_cross_validation, etc.)</span></span>
<span><span class="va">model_spec</span><span class="op">$</span><span class="va">compute_performance</span>  <span class="co"># logical: compute metrics after fold merging</span></span>
<span><span class="va">model_spec</span><span class="op">$</span><span class="va">return_predictions</span>   <span class="co"># logical: return per-fold predictions</span></span>
<span><span class="va">model_spec</span><span class="op">$</span><span class="va">return_fits</span>      <span class="co"># logical: keep fitted models</span></span>
<span><span class="va">model_spec</span><span class="op">$</span><span class="va">performance</span>      <span class="co"># function: (result) -&gt; named_metrics</span></span>
<span><span class="va">model_spec</span><span class="op">$</span><span class="va">has_test_set</span>     <span class="co"># logical: external test set present</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_13-hrfdecoder-plugin-specialized-model-spec">1.3 hrfdecoder Plugin: Specialized Model Spec<a class="anchor" aria-label="anchor" href="#id_13-hrfdecoder-plugin-specialized-model-spec"></a></h3>
<p><strong>File</strong>: <code>/R/hrfdecoder_model.R:97-146</code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>hrfdecoder_model <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  dataset,           <span class="co"># mvpa_dataset with TR x V data</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  design,            <span class="co"># hrfdecoder_design (custom mvpa_design subclass)</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="at">lambda_W =</span> <span class="dv">10</span>,     <span class="co"># ridge penalty for decoder weights</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  <span class="at">lambda_HRF =</span> <span class="dv">1</span>,    <span class="co"># HRF conformity penalty</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  <span class="at">lambda_smooth =</span> <span class="dv">5</span>, <span class="co"># temporal smoothness penalty</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="at">basis =</span> <span class="cn">NULL</span>,      <span class="co"># HRF basis (fmrihrf::spmg1, etc.)</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>  <span class="at">window =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">8</span>),  <span class="co"># event aggregation window (seconds)</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  <span class="at">nonneg =</span> <span class="cn">TRUE</span>,     <span class="co"># project soft labels to [0,1]</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>  <span class="at">max_iter =</span> <span class="dv">10</span>,     <span class="co"># ALS iterations</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>  <span class="at">tol =</span> <span class="fl">1e-4</span>,        <span class="co"># convergence tolerance</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>  <span class="at">performance =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>  <span class="at">crossval =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>  <span class="at">return_predictions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>  <span class="at">return_fits =</span> <span class="cn">FALSE</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>)</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="co"># Returns: S3 object with class c("hrfdecoder_model", "model_spec", "list")</span></span></code></pre></div>
<p><strong>Key Differences from Standard MVPA Models</strong>: - Operates on TR-level (continuous) data, not trial-level betas - <code><a href="http://bbuchsbaum.github.io/rMVPA/reference/y_train-methods.html" class="external-link">y_train()</a></code> returns dummy TR sequence (1:T) for fold construction - Actual targets come from <code>design$event_model</code> and <code>design$events</code> (ignored by fold machinery) - Fold assignment determined by <code>block_var</code> (run IDs), not <code>y_train</code> values</p>
</div>
<div class="section level3">
<h3 id="id_14-s3-method-implementation-pattern">1.4 S3 Method Implementation Pattern<a class="anchor" aria-label="anchor" href="#id_14-s3-method-implementation-pattern"></a></h3>
<p>Example from hrfdecoder:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># STEP 1: y_train extraction (for fold construction)</span></span>
<span><span class="va">y_train.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/nobs.html" class="external-link">nobs</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">dataset</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Dummy sequence 1:T</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># STEP 2: Model training (ignored y parameter, uses design metadata)</span></span>
<span><span class="va">train_model.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">train_dat</span>, <span class="va">y</span>, <span class="va">sl_info</span>, <span class="va">cv_spec</span>, <span class="va">indices</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">train_dat</span><span class="op">)</span></span>
<span>  <span class="va">evm</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">event_model</span></span>
<span>  <span class="va">events</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">events</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">hrfdecoder</span><span class="fu">::</span><span class="fu">hrfdecoder_fit</span><span class="op">(</span><span class="va">X</span>, event_model<span class="op">=</span><span class="va">evm</span>, basis<span class="op">=</span><span class="va">obj</span><span class="op">$</span><span class="va">basis</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fit<span class="op">=</span><span class="va">fit</span>, sl_info<span class="op">=</span><span class="va">sl_info</span>, indices<span class="op">=</span><span class="va">indices</span><span class="op">)</span>, </span>
<span>            class<span class="op">=</span><span class="st">"hrfdecoder_fit_wrap"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># STEP 3: Format fold result (predict + aggregate to events)</span></span>
<span><span class="va">format_result.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">result</span>, <span class="va">error_message</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">context</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Xtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">context</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span>  <span class="va">Ptest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">fit</span>, <span class="va">Xtest</span><span class="op">)</span>  <span class="co"># TR-level soft labels</span></span>
<span>  <span class="va">agg</span> <span class="op">&lt;-</span> <span class="fu">hrfdecoder</span><span class="fu">::</span><span class="fu">aggregate_events</span><span class="op">(</span><span class="va">Ptest</span>, <span class="va">obj</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">events</span>, window<span class="op">=</span><span class="va">obj</span><span class="op">$</span><span class="va">window</span><span class="op">)</span></span>
<span>  <span class="co"># Return tibble with event-level probs and predictions</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># STEP 4: Merge fold results</span></span>
<span><span class="va">merge_results.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">result_set</span>, <span class="va">indices</span>, <span class="va">id</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Concatenate fold results, build classification_result, compute performance</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># STEP 5: Compute performance</span></span>
<span><span class="va">compute_performance.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">result</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">obj</span><span class="op">$</span><span class="fu">performance</span><span class="op">(</span><span class="va">result</span><span class="op">)</span>  <span class="co"># Delegates to perf_fun</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_2-data-flow-searchlight-and-cross-validation">2. Data Flow: Searchlight and Cross-Validation<a class="anchor" aria-label="anchor" href="#id_2-data-flow-searchlight-and-cross-validation"></a></h2>
<div class="section level3">
<h3 id="id_21-roisearchlight-extraction--cross-validation-folds--trainingtesting">2.1 ROI/Searchlight Extraction → Cross-Validation Folds → Training/Testing<a class="anchor" aria-label="anchor" href="#id_21-roisearchlight-extraction--cross-validation-folds--trainingtesting"></a></h3>
<p><strong>Main Pipeline</strong> (from <code>/R/mvpa_iterate.R</code> and <code>/R/allgeneric.R</code>):</p>
<pre><code>process_roi(mod_spec, roi, rnum, center_global_id)
  ├─→ Check for external test set (has_test_set)
  │    └─→ external_crossval(mspec, roi, id, center_global_id)
  ├─→ Check for internal cross-validation (has_crossval)
  │    └─→ internal_crossval(mspec, roi, id, center_global_id)
  └─→ Fallback: no CV
       └─→ process_roi_default(mspec, roi, rnum, center_global_id)</code></pre>
</div>
<div class="section level3">
<h3 id="id_22-internal-cross-validation-most-common">2.2 Internal Cross-Validation (Most Common)<a class="anchor" aria-label="anchor" href="#id_22-internal-cross-validation-most-common"></a></h3>
<p><strong>Function</strong>: <code>/R/mvpa_iterate.R:224-296</code></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">internal_crossval</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mspec</span>, <span class="va">roi</span>, <span class="va">id</span>, <span class="va">center_global_id</span> <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># 1. EXTRACT DATA: Get train_roi from searchlight/region</span></span>
<span>  <span class="va">xtrain</span> <span class="op">&lt;-</span> <span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/values-methods.html" class="external-link">values</a></span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span><span class="op">)</span>  <span class="co"># ROI matrix: obs x features</span></span>
<span>  <span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/indices.html" class="external-link">indices</a></span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span><span class="op">)</span>     <span class="co"># Global voxel indices</span></span>
<span>  </span>
<span>  <span class="co"># 2. GENERATE FOLDS: Create train/test splits based on crossval spec</span></span>
<span>  <span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/crossval_samples.html" class="external-link">crossval_samples</a></span><span class="op">(</span></span>
<span>    <span class="va">mspec</span><span class="op">$</span><span class="va">crossval</span>,</span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">xtrain</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/y_train-methods.html" class="external-link">y_train</a></span><span class="op">(</span><span class="va">mspec</span><span class="op">)</span>  <span class="co"># For hrfdecoder: dummy TR sequence</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># Returns tibble with columns: ytrain, ytest, train, test, .id</span></span>
<span>  </span>
<span>  <span class="co"># 3. ITERATE FOLDS: For each fold</span></span>
<span>  <span class="va">ret</span> <span class="op">&lt;-</span> <span class="va">samples</span> <span class="op">%&gt;%</span> <span class="fu">pmap</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">ytrain</span>, <span class="va">ytest</span>, <span class="va">train</span>, <span class="va">test</span>, <span class="va">.id</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># 3a. TRAIN</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/train_model.html" class="external-link">train_model</a></span><span class="op">(</span></span>
<span>      <span class="va">mspec</span>, </span>
<span>      <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span>,</span>
<span>      <span class="va">ytrain</span>,           <span class="co"># For hrfdecoder: dummy sequence</span></span>
<span>      sl_info <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">center_local_id</span>, <span class="va">center_global_id</span><span class="op">)</span>,</span>
<span>      cv_spec <span class="op">=</span> <span class="va">mspec</span><span class="op">$</span><span class="va">crossval</span>,</span>
<span>      indices <span class="op">=</span> <span class="va">ind</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># 3b. FORMAT (predict + aggregate)</span></span>
<span>    <span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/format_result.html" class="external-link">format_result</a></span><span class="op">(</span></span>
<span>      <span class="va">mspec</span>, <span class="va">result</span>, </span>
<span>      error_message <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>      context <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        test <span class="op">=</span> <span class="va">test</span>,      <span class="co"># Test ROI data</span></span>
<span>        ytest <span class="op">=</span> <span class="va">ytest</span>,    <span class="co"># Test labels/dummy</span></span>
<span>        <span class="va">...</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># 4. MERGE FOLDS: Aggregate across folds</span></span>
<span>  <span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/merge_results.html" class="external-link">merge_results</a></span><span class="op">(</span><span class="va">mspec</span>, <span class="va">ret</span>, indices<span class="op">=</span><span class="va">ind</span>, id<span class="op">=</span><span class="va">id</span><span class="op">)</span></span>
<span>  <span class="co"># Returns: tibble with result, indices, performance, id, error</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Key Insight</strong>: Data extraction (step 1) happens <strong>before</strong> fold creation. This means: - <strong>Preprocessing MUST happen before fold iteration</strong> to avoid data leakage - Preprocessing can be done per-ROI, before step 2 - No per-fold preprocessing without custom handling</p>
</div>
<div class="section level3">
<h3 id="id_23-cross-validation-specification">2.3 Cross-Validation Specification<a class="anchor" aria-label="anchor" href="#id_23-cross-validation-specification"></a></h3>
<p><strong>File</strong>: <code>/R/crossval.R:402-546</code></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/cross_validation.html" class="external-link">blocked_cross_validation</a></span><span class="op">(</span><span class="va">block_var</span><span class="op">)</span></span>
<span><span class="co"># Standard: leave one block (run) out at a time</span></span>
<span><span class="co"># Returns: object with class "blocked_cross_validation"</span></span>
<span><span class="co"># Used by: crossval_samples() → creates folds</span></span>
<span></span>
<span><span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/cross_validation.html" class="external-link">sequential_blocked_cross_validation</a></span><span class="op">(</span><span class="va">block_var</span>, nfolds<span class="op">=</span><span class="fl">2</span>, nreps<span class="op">=</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="co"># Advanced: subdivides each block further</span></span>
<span></span>
<span><span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/cross_validation.html" class="external-link">custom_cross_validation</a></span><span class="op">(</span><span class="va">sample_set</span><span class="op">)</span></span>
<span><span class="co"># User provides explicit train/test index pairs</span></span></code></pre></div>
<p>Implementation:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">crossval_samples.blocked_cross_validation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">data</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/crossv_block.html" class="external-link">crossv_block</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">y</span>, <span class="va">obj</span><span class="op">$</span><span class="va">block_var</span><span class="op">)</span></span>
<span>  <span class="co"># Returns: tibble(ytrain, ytest, train, test, .id) for each fold</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_24-data-sample-structure">2.4 Data Sample Structure<a class="anchor" aria-label="anchor" href="#id_24-data-sample-structure"></a></h3>
<p>The extracted ROI data is wrapped in <strong>modelr::resample</strong> objects (lightweight index-based views):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inside crossval_samples:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  ytrain <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="va">train_indices</span><span class="op">]</span>,</span>
<span>  ytest <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="va">test_indices</span><span class="op">]</span>,</span>
<span>  train <span class="op">=</span> <span class="fu">modelr</span><span class="fu">::</span><span class="fu"><a href="https://modelr.tidyverse.org/reference/resample.html" class="external-link">resample</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">train_indices</span><span class="op">)</span>,  <span class="co"># Lazy view</span></span>
<span>  test <span class="op">=</span> <span class="fu">modelr</span><span class="fu">::</span><span class="fu"><a href="https://modelr.tidyverse.org/reference/resample.html" class="external-link">resample</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">test_indices</span><span class="op">)</span>      <span class="co"># Lazy view</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Unpacking for model training:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xtrain</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">train</span>, .name_repair<span class="op">=</span><span class="va">.name_repair</span><span class="op">)</span></span>
<span><span class="co"># Converts to matrix/tibble of actual values</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_3-existing-preprocessing-capabilities">3. Existing Preprocessing Capabilities<a class="anchor" aria-label="anchor" href="#id_3-existing-preprocessing-capabilities"></a></h2>
<div class="section level3">
<h3 id="id_31-dataset-level-normalization">3.1 Dataset-Level Normalization<a class="anchor" aria-label="anchor" href="#id_31-dataset-level-normalization"></a></h3>
<p><strong>File</strong>: <code>/R/common.R:52-88</code></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Per-volume z-scoring (before fold creation)</span></span>
<span><span class="va">normalize_image_samples</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bvec</span>, <span class="va">mask</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Scale each volume independently</span></span>
<span>  <span class="va">vlist</span> <span class="op">&lt;-</span> <span class="fu">vols</span><span class="op">(</span><span class="va">bvec</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">future_map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">v</span><span class="op">[</span><span class="va">mask</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu">SparseNeuroVec</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">vlist</span><span class="op">)</span>, <span class="fu">space</span><span class="op">(</span><span class="va">bvec</span><span class="op">)</span>, mask<span class="op">=</span><span class="va">mask</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Per-block standardization (within-run z-scoring)</span></span>
<span><span class="va">standardize_vars</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bvec</span>, <span class="va">mask</span>, <span class="va">blockvar</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Split by block, z-score within each block</span></span>
<span>  <span class="va">vlist</span> <span class="op">&lt;-</span> <span class="fu">vectors</span><span class="op">(</span><span class="va">bvec</span>, subset<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">mask</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">future_map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu">map</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">v</span>, <span class="va">blockvar</span><span class="op">)</span>, <span class="va">scale</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu">SparseNeuroVec</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">vlist</span><span class="op">)</span>, <span class="fu">space</span><span class="op">(</span><span class="va">bvec</span><span class="op">)</span>, mask<span class="op">=</span><span class="va">mask</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>When Applied</strong>: During dataset initialization in the configuration pipeline (not fold-aware).</p>
</div>
<div class="section level3">
<h3 id="id_32-feature-selection">3.2 Feature Selection<a class="anchor" aria-label="anchor" href="#id_32-feature-selection"></a></h3>
<p><strong>File</strong>: <code>/R/feature_selection.R</code> and <code>/R/allgeneric.R:36-64</code></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">select_features</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">X</span>, <span class="va">Y</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="co"># Generic called within internal_crossval before training</span></span>
<span><span class="co"># Returns: logical vector of selected features</span></span>
<span></span>
<span><span class="co"># Implemented in mvpa_model:</span></span>
<span><span class="va">select_features.mvpa_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">X</span>, <span class="va">Y</span>,<span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">feature_selector</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/select_features-methods.html" class="external-link">select_features</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">feature_selector</span>, <span class="va">X</span>, <span class="va">Y</span>,<span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>  <span class="co"># No selection</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Timing</strong>: Called per-fold <strong>within</strong> <code>internal_crossval</code> <strong>after</strong> fold split. Avoids feature selection bias.</p>
</div>
<div class="section level3">
<h3 id="id_33-nuisance-regression--ar-handling">3.3 Nuisance Regression &amp; AR Handling<a class="anchor" aria-label="anchor" href="#id_33-nuisance-regression--ar-handling"></a></h3>
<p><strong>Current Status</strong>: <strong>NOT IMPLEMENTED</strong> in rMVPA core.</p>
<ul><li>No built-in AR whitening, ARMA models, or nuisance regression</li>
<li>Normalization (<code>normalize_samples</code> flag in config) is limited to z-scoring</li>
<li><strong>This is a key integration point for hrfdecoder’s prewhitening</strong></li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="id_4-configuration-and-hyperparameters">4. Configuration and Hyperparameters<a class="anchor" aria-label="anchor" href="#id_4-configuration-and-hyperparameters"></a></h2>
<div class="section level3">
<h3 id="id_41-model-specification-flow">4.1 Model Specification Flow<a class="anchor" aria-label="anchor" href="#id_41-model-specification-flow"></a></h3>
<pre><code>mvpa_model()                          # Specify model, dataset, design
    ↓
create_model_spec()                   # Build S3 object
    ↓
run_searchlight(model_spec, ...)      # Execute searchlight
    ↓
process_roi(model_spec, roi, ...)     # Per-ROI entry point
    ↓
internal_crossval(model_spec, ...)    # CV iteration
    ↓
train_model(model_spec, ...)          # Delegate to S3 method</code></pre>
</div>
<div class="section level3">
<h3 id="id_42-hyperparameter-specification">4.2 Hyperparameter Specification<a class="anchor" aria-label="anchor" href="#id_42-hyperparameter-specification"></a></h3>
<p><strong>For standard models</strong> (e.g., <code>sda_notune</code>): - Passed via <code>model</code> object in registry (MVPAModels) - <code>fit(x, y, wts, param, lev, last, weights, classProbs, ...)</code> signature</p>
<p><strong>For hrfdecoder</strong>: - Passed as explicit function arguments: <code>lambda_W</code>, <code>lambda_HRF</code>, <code>lambda_smooth</code>, etc. - Stored directly in model spec - Accessed in <code>train_model.hrfdecoder_model()</code> via <code>obj$lambda_W</code>, etc.</p>
</div>
<div class="section level3">
<h3 id="id_43-cross-validation-interaction-with-preprocessing">4.3 Cross-Validation Interaction with Preprocessing<a class="anchor" aria-label="anchor" href="#id_43-cross-validation-interaction-with-preprocessing"></a></h3>
<p><strong>Key Issue</strong>: CV folds created <strong>after</strong> ROI extraction but preprocessing timing matters:</p>
<pre><code>ROI Extracted → [PREPROCESSING WINDOW] → Folds Created → Train/Test per Fold</code></pre>
<p><strong>For AR Prewhitening</strong>: 1. Must happen <strong>before</strong> fold creation to avoid cross-fold contamination 2. Must use <strong>training data only</strong> per fold (inside <code>train_model</code>) 3. Decoder weights fit on prewhitened training data 4. Test predictions made on independently prewhitened test data</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_5-integration-points-for-hrfdecoder">5. Integration Points for hrfdecoder<a class="anchor" aria-label="anchor" href="#id_5-integration-points-for-hrfdecoder"></a></h2>
<div class="section level3">
<h3 id="id_51-where-prewhitening-fits">5.1 Where Prewhitening Fits<a class="anchor" aria-label="anchor" href="#id_51-where-prewhitening-fits"></a></h3>
<p><strong>Option A: Per-ROI, Before Fold Creation</strong> (Preferred for AR)</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">process_roi_with_prewhitening</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mspec</span>, <span class="va">roi</span>, <span class="va">rnum</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Extract ROI data</span></span>
<span>  <span class="va">roi_data</span> <span class="op">&lt;-</span> <span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/values-methods.html" class="external-link">values</a></span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># PREWHITEN per ROI (not per fold)</span></span>
<span>  <span class="va">roi_data_pw</span> <span class="op">&lt;-</span> <span class="fu">prewhiten_ar</span><span class="op">(</span><span class="va">roi_data</span>, <span class="va">mspec</span><span class="op">$</span><span class="va">ar_order</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Update roi with prewhitened data</span></span>
<span>  <span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span> <span class="op">&lt;-</span> <span class="fu">update_roi_data</span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span>, <span class="va">roi_data_pw</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Proceed with normal flow</span></span>
<span>  <span class="fu">internal_crossval</span><span class="op">(</span><span class="va">mspec</span>, <span class="va">roi</span>, <span class="va">rnum</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Option B: Per-Fold, Inside <code>train_model</code></strong> (Fold-specific AR params)</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_model.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">train_dat</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">train_dat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Estimate AR model and prewhiten TRAINING data only</span></span>
<span>  <span class="va">X_pw</span> <span class="op">&lt;-</span> <span class="fu">prewhiten_ar_estimate</span><span class="op">(</span><span class="va">X</span>, <span class="va">obj</span><span class="op">$</span><span class="va">ar_order</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Fit decoder on prewhitened data</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">hrfdecoder</span><span class="fu">::</span><span class="fu">hrfdecoder_fit</span><span class="op">(</span><span class="va">X_pw</span>, event_model<span class="op">=</span><span class="va">obj</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">event_model</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Store AR parameters for test data</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fit<span class="op">=</span><span class="va">fit</span>, ar_params<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">X_pw</span>, <span class="st">"ar_params"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            class<span class="op">=</span><span class="st">"hrfdecoder_fit_wrap"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">format_result.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">result</span>, <span class="va">error_message</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">context</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Xtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">context</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Apply SAME AR whitening to test data</span></span>
<span>  <span class="va">Xtest_pw</span> <span class="op">&lt;-</span> <span class="fu">apply_ar_whitening</span><span class="op">(</span><span class="va">Xtest</span>, <span class="va">result</span><span class="op">$</span><span class="va">ar_params</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">Ptest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">fit</span>, <span class="va">Xtest_pw</span><span class="op">)</span></span>
<span>  <span class="co"># ... rest of aggregation</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_52-design-extension-hrfdecoder_design">5.2 Design Extension: <code>hrfdecoder_design</code>
<a class="anchor" aria-label="anchor" href="#id_52-design-extension-hrfdecoder_design"></a></h3>
<p><strong>File</strong>: <code>/R/hrfdecoder_design.R:60-130</code></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hrfdecoder_design</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">event_model</span>, <span class="va">events</span>, <span class="va">block_var</span>, <span class="va">split_by</span><span class="op">=</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Creates mvpa_design subclass with additional fields</span></span>
<span>  </span>
<span>  <span class="va">mvdes</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://bbuchsbaum.github.io/rMVPA/reference/mvpa_design.html" class="external-link">mvpa_design</a></span><span class="op">(</span></span>
<span>    train_design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">Tlen</span><span class="op">)</span>, block <span class="op">=</span> <span class="va">block_var</span><span class="op">)</span>,</span>
<span>    y_train <span class="op">=</span> <span class="op">~</span> <span class="va">y</span>,           <span class="co"># Dummy: TR indices</span></span>
<span>    block_var <span class="op">=</span> <span class="op">~</span> <span class="va">block</span>,     <span class="co"># Run IDs - DETERMINES folds</span></span>
<span>    split_by <span class="op">=</span> <span class="va">split_by</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Attach metadata</span></span>
<span>  <span class="va">mvdes</span><span class="op">$</span><span class="va">event_model</span> <span class="op">&lt;-</span> <span class="va">event_model</span>   <span class="co"># fmridesign object</span></span>
<span>  <span class="va">mvdes</span><span class="op">$</span><span class="va">events</span> <span class="op">&lt;-</span> <span class="va">events</span>              <span class="co"># event-level labels</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">mvdes</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hrfdecoder_design"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">mvdes</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mvdes</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Key</strong>: Block-level CV ensures entire runs are held out (respects temporal structure).</p>
</div>
<div class="section level3">
<h3 id="id_53-model-specific-preprocessing-hook">5.3 Model-Specific Preprocessing Hook<a class="anchor" aria-label="anchor" href="#id_53-model-specific-preprocessing-hook"></a></h3>
<p><strong>New Generic Function</strong> (could be added):</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preprocess_roi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">roi</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"preprocess_roi"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">preprocess_roi.default</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">roi</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">roi</span>  <span class="co"># No preprocessing</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">preprocess_roi.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">roi</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Apply AR prewhitening</span></span>
<span>  <span class="va">roi_data</span> <span class="op">&lt;-</span> <span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/values-methods.html" class="external-link">values</a></span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span><span class="op">)</span></span>
<span>  <span class="va">roi_data_pw</span> <span class="op">&lt;-</span> <span class="fu">apply_prewhitening</span><span class="op">(</span><span class="va">roi_data</span>, <span class="va">obj</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Update roi</span></span>
<span>  <span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span> <span class="op">&lt;-</span> <span class="fu">replace_roi_data</span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span>, <span class="va">roi_data_pw</span><span class="op">)</span></span>
<span>  <span class="va">roi</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Called from <code>process_roi.default</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">process_roi.default</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod_spec</span>, <span class="va">roi</span>, <span class="va">rnum</span>, <span class="va">center_global_id</span> <span class="op">=</span> <span class="cn">NA</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">roi</span> <span class="op">&lt;-</span> <span class="fu">preprocess_roi</span><span class="op">(</span><span class="va">mod_spec</span>, <span class="va">roi</span><span class="op">)</span>  <span class="co"># NEW HOOK</span></span>
<span>  </span>
<span>  <span class="va">xtrain</span> <span class="op">&lt;-</span> <span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/values-methods.html" class="external-link">values</a></span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span><span class="op">)</span></span>
<span>  <span class="co"># ... rest of pipeline</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_6-key-architectural-patterns">6. Key Architectural Patterns<a class="anchor" aria-label="anchor" href="#id_6-key-architectural-patterns"></a></h2>
<div class="section level3">
<h3 id="id_61-s3-method-resolution-order">6.1 S3 Method Resolution Order<a class="anchor" aria-label="anchor" href="#id_61-s3-method-resolution-order"></a></h3>
<p>For hrfdecoder model operations:</p>
<pre><code>train_model(hrfdecoder_model, ...)
  → train_model.hrfdecoder_model()

format_result(hrfdecoder_model, ...)
  → format_result.hrfdecoder_model()

merge_results(hrfdecoder_model, ...)
  → merge_results.hrfdecoder_model()</code></pre>
<p>Each method receives the full model_spec object, allowing access to all parameters.</p>
</div>
<div class="section level3">
<h3 id="id_62-preprocessing-timing-patterns">6.2 Preprocessing Timing Patterns<a class="anchor" aria-label="anchor" href="#id_62-preprocessing-timing-patterns"></a></h3>
<pre><code>PATTERN 1: Dataset-level (immediate, no folds)
  mvpa_dataset() → normalize_image_samples() → data ready

PATTERN 2: Per-ROI (before fold iteration)
  process_roi() → [preprocess_roi() NEW] → internal_crossval()

PATTERN 3: Per-Fold (inside train_model)
  internal_crossval() → train_model() → [local preprocessing] → fit()

PATTERN 4: Test Data (must use training params)
  format_result() → [apply training preprocessing] → predict()</code></pre>
</div>
<div class="section level3">
<h3 id="id_63-result-aggregation-hierarchy">6.3 Result Aggregation Hierarchy<a class="anchor" aria-label="anchor" href="#id_63-result-aggregation-hierarchy"></a></h3>
<pre><code>Fold-Level Results (format_result):
  class: tibble with columns [class, probs, y_true, test_ind, fit, error, error_message]

ROI-Level Results (merge_results):
  class: tibble with columns [result, indices, performance, id, error, error_message]
  - Combines all folds into single classification_result
  - Computes metrics via compute_performance()

Searchlight Results (wrap_out, run_searchlight):
  class: searchlight_result (list of NeuroVol/NeuroSurface maps)</code></pre>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_7-file-organization-reference">7. File Organization Reference<a class="anchor" aria-label="anchor" href="#id_7-file-organization-reference"></a></h2>
<table class="table"><colgroup><col width="22%"><col width="33%"><col width="44%"></colgroup><thead><tr><th>File</th>
<th>Purpose</th>
<th>Key Content</th>
</tr></thead><tbody><tr><td><code>allgeneric.R</code></td>
<td>Generic function definitions</td>
<td>
<code>train_model</code>, <code>predict_model</code>, <code>format_result</code>, <code>merge_results</code>, <code>process_roi</code>
</td>
</tr><tr><td><code>mvpa_model.R</code></td>
<td>Standard MVPA model spec</td>
<td>
<code><a href="http://bbuchsbaum.github.io/rMVPA/reference/mvpa_model.html" class="external-link">mvpa_model()</a></code>, <code>create_model_spec()</code>, S3 methods</td>
</tr><tr><td><code>hrfdecoder_model.R</code></td>
<td>hrfdecoder adapter</td>
<td>
<code><a href="reference/hrfdecoder_model.html">hrfdecoder_model()</a></code>, <code>train_model.hrfdecoder_model()</code>, <code>format_result.hrfdecoder_model()</code>
</td>
</tr><tr><td><code>hrfdecoder_design.R</code></td>
<td>hrfdecoder design extension</td>
<td>
<code><a href="http://bbuchsbaum.github.io/rMVPA/reference/hrfdecoder_design.html" class="external-link">hrfdecoder_design()</a></code>, validation, metadata attachment</td>
</tr><tr><td><code>mvpa_iterate.R</code></td>
<td>CV iteration logic</td>
<td>
<code>internal_crossval()</code>, <code>external_crossval()</code>, fold generation</td>
</tr><tr><td><code>crossval.R</code></td>
<td>CV specification classes</td>
<td>
<code><a href="http://bbuchsbaum.github.io/rMVPA/reference/cross_validation.html" class="external-link">blocked_cross_validation()</a></code>, <code><a href="http://bbuchsbaum.github.io/rMVPA/reference/crossval_samples.html" class="external-link">crossval_samples()</a></code>
</td>
</tr><tr><td><code>model_fit.R</code></td>
<td>Model tuning utilities</td>
<td>
<code>tune_model()</code>, caret integration</td>
</tr><tr><td><code>common.R</code></td>
<td>Normalization utilities</td>
<td>
<code>normalize_image_samples()</code>, <code>standardize_vars()</code>
</td>
</tr><tr><td><code>searchlight.R</code></td>
<td>Searchlight iteration</td>
<td>
<code><a href="http://bbuchsbaum.github.io/rMVPA/reference/run_searchlight.html" class="external-link">run_searchlight()</a></code>, output wrapping</td>
</tr><tr><td><code>regional.R</code></td>
<td>Regional analysis</td>
<td>
<code><a href="http://bbuchsbaum.github.io/rMVPA/reference/run_regional-methods.html" class="external-link">run_regional()</a></code>, region mask handling</td>
</tr><tr><td><code>dataset.R</code></td>
<td>Dataset structures</td>
<td>
<code><a href="http://bbuchsbaum.github.io/rMVPA/reference/mvpa_dataset.html" class="external-link">mvpa_dataset()</a></code>, <code><a href="http://bbuchsbaum.github.io/rMVPA/reference/gen_sample_dataset.html" class="external-link">gen_sample_dataset()</a></code>
</td>
</tr><tr><td><code>design.R</code></td>
<td>Design specifications</td>
<td>
<code><a href="http://bbuchsbaum.github.io/rMVPA/reference/mvpa_design.html" class="external-link">mvpa_design()</a></code>, formula parsing</td>
</tr><tr><td><code>classifiers.R</code></td>
<td>Model registry</td>
<td>
<code>MVPAModels</code> environment, <code><a href="http://bbuchsbaum.github.io/rMVPA/reference/load_model.html" class="external-link">load_model()</a></code>
</td>
</tr></tbody></table><hr></div>
<div class="section level2">
<h2 id="id_8-integration-checklist-for-ar-prewhitening">8. Integration Checklist for AR Prewhitening<a class="anchor" aria-label="anchor" href="#id_8-integration-checklist-for-ar-prewhitening"></a></h2>
<ul class="task-list"><li><label><input type="checkbox">Implement <code>preprocess_roi()</code> generic function</label></li>
<li><label><input type="checkbox">Add <code>preprocess_roi.hrfdecoder_model()</code> method</label></li>
<li><label><input type="checkbox">Store AR parameters in fit object for test data application</label></li>
<li><label><input type="checkbox">Ensure <code>format_result.hrfdecoder_model()</code> applies same AR transform to test data</label></li>
<li><label><input type="checkbox">Validate that prewhitening happens before fold creation (no data leakage)</label></li>
<li><label><input type="checkbox">Document AR parameter control in <code><a href="reference/hrfdecoder_model.html">hrfdecoder_model()</a></code> signature</label></li>
<li><label><input type="checkbox">Test with cross-validation to ensure train/test independence</label></li>
<li><label><input type="checkbox">Add <code>ar_order</code> parameter to <code><a href="reference/hrfdecoder_model.html">hrfdecoder_model()</a></code> spec</label></li>
<li><label><input type="checkbox">Consider model-agnostic interface for other preprocessing (nuisance regression, etc.)</label></li>
</ul><hr></div>
<div class="section level2">
<h2 id="id_9-recommended-preprocessing-architecture-for-hrfdecoder">9. Recommended Preprocessing Architecture for hrfdecoder<a class="anchor" aria-label="anchor" href="#id_9-recommended-preprocessing-architecture-for-hrfdecoder"></a></h2>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Apply AR Prewhitening to ROI Data</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param obj hrfdecoder_model spec</span></span>
<span><span class="co">#' @param roi ROI data (list with train_roi)</span></span>
<span><span class="co">#' @param ... Additional args</span></span>
<span><span class="co">#' @return roi with prewhitened train_roi</span></span>
<span><span class="va">preprocess_roi.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">roi</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">ar_order</span><span class="op">)</span> <span class="op">||</span> <span class="va">obj</span><span class="op">$</span><span class="va">ar_order</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">roi</span><span class="op">)</span>  <span class="co"># No whitening</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">roi_data</span> <span class="op">&lt;-</span> <span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/values-methods.html" class="external-link">values</a></span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Fit AR model per voxel</span></span>
<span>  <span class="va">ar_fit</span> <span class="op">&lt;-</span> <span class="fu">fit_ar_model</span><span class="op">(</span><span class="va">roi_data</span>, <span class="va">obj</span><span class="op">$</span><span class="va">ar_order</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Prewhiten data</span></span>
<span>  <span class="va">roi_data_pw</span> <span class="op">&lt;-</span> <span class="fu">apply_ar_whitening</span><span class="op">(</span><span class="va">roi_data</span>, <span class="va">ar_fit</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Update roi, preserving indices and metadata</span></span>
<span>  <span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span><span class="op">@</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">roi_data_pw</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">train_roi</span>, <span class="st">"ar_fit"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">ar_fit</span></span>
<span>  </span>
<span>  <span class="va">roi</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Inside train_model:</span></span>
<span><span class="va">train_model.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">train_dat</span>, <span class="va">y</span>, <span class="va">sl_info</span>, <span class="va">cv_spec</span>, <span class="va">indices</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">train_dat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Check if ar_fit is pre-computed (from preprocess_roi)</span></span>
<span>  <span class="va">ar_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">train_dat</span>, <span class="st">"ar_fit"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">ar_fit</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Already prewhitened</span></span>
<span>    <span class="va">X_pw</span> <span class="op">&lt;-</span> <span class="va">X</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">ar_order</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">obj</span><span class="op">$</span><span class="va">ar_order</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Estimate per-fold</span></span>
<span>    <span class="va">ar_fit</span> <span class="op">&lt;-</span> <span class="fu">fit_ar_model</span><span class="op">(</span><span class="va">X</span>, <span class="va">obj</span><span class="op">$</span><span class="va">ar_order</span><span class="op">)</span></span>
<span>    <span class="va">X_pw</span> <span class="op">&lt;-</span> <span class="fu">apply_ar_whitening</span><span class="op">(</span><span class="va">X</span>, <span class="va">ar_fit</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">X_pw</span> <span class="op">&lt;-</span> <span class="va">X</span></span>
<span>    <span class="va">ar_fit</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">hrfdecoder</span><span class="fu">::</span><span class="fu">hrfdecoder_fit</span><span class="op">(</span><span class="va">X_pw</span>, event_model<span class="op">=</span><span class="va">obj</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">event_model</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fit<span class="op">=</span><span class="va">fit</span>, ar_fit<span class="op">=</span><span class="va">ar_fit</span>, sl_info<span class="op">=</span><span class="va">sl_info</span>, indices<span class="op">=</span><span class="va">indices</span><span class="op">)</span>,</span>
<span>    class<span class="op">=</span><span class="st">"hrfdecoder_fit_wrap"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Inside format_result:</span></span>
<span><span class="va">format_result.hrfdecoder_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">result</span>, <span class="va">error_message</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">context</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Xtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">context</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Apply same AR whitening to test data</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">ar_fit</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Xtest_pw</span> <span class="op">&lt;-</span> <span class="fu">apply_ar_whitening</span><span class="op">(</span><span class="va">Xtest</span>, <span class="va">result</span><span class="op">$</span><span class="va">ar_fit</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">Xtest_pw</span> <span class="op">&lt;-</span> <span class="va">Xtest</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">Ptest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">fit</span>, <span class="va">Xtest_pw</span><span class="op">)</span></span>
<span>  <span class="co"># ... aggregation and result formatting</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This architecture ensures: 1. <strong>Train/test separation</strong>: Each fold’s AR model estimated from training data only 2. <strong>Consistency</strong>: Test data transformed using training fold’s AR parameters 3. <strong>Model transparency</strong>: AR fit stored in result object for inspection 4. <strong>Flexibility</strong>: Works with or without prewhitening 5. <strong>Extensibility</strong>: Same pattern works for other preprocessing (nuisance regression, etc.)</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Your Name.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

